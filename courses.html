<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Find the right First Aid course for you. Answer a few quick questions and get a personalised recommendation. CPR, First Aid, Childcare & Advanced courses. RTO #32221.">
    <meta property="og:title" content="Find Your Course | Coral Sea Training">
    <meta property="og:description" content="Answer a few quick questions and get a personalised First Aid course recommendation. RTO #32221.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jgold43.github.io/coral-sea-training/courses.html">
    <meta property="og:image" content="https://images.pexels.com/photos/11655091/pexels-photo-11655091.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2">
    <link rel="canonical" href="https://jgold43.github.io/coral-sea-training/courses.html">
    <title>Find Your Course | Coral Sea Training | RTO #32221</title>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%231B8A3D' stroke='%23D90A0A' stroke-width='6'/%3E%3Ctext x='50' y='68' text-anchor='middle' fill='white' font-size='50' font-weight='bold'%3E+%3C/text%3E%3C/svg%3E">
    <style>
        /* Tooltip component */
        .funnel-tooltip-trigger { position:relative; cursor:help; font-size:0.875rem; color:var(--gray-400); font-style:normal; margin-left:4px; }
        .funnel-tooltip-trigger:hover::after, .funnel-tooltip-trigger:focus::after {
            content:attr(data-tooltip); position:absolute; bottom:calc(100% + 8px); left:50%; transform:translateX(-50%);
            background:var(--navy); color:white; font-size:0.75rem; font-weight:400; line-height:1.4; padding:8px 12px;
            border-radius:8px; white-space:normal; width:240px; z-index:10; box-shadow:0 4px 12px rgba(0,0,0,0.15);
            pointer-events:none;
        }
        .funnel-tooltip-trigger:hover::before, .funnel-tooltip-trigger:focus::before {
            content:''; position:absolute; bottom:calc(100% + 2px); left:50%; transform:translateX(-50%);
            border:6px solid transparent; border-top-color:var(--navy); z-index:10;
        }
        /* Trainer card */
        .trainer-card { text-align:center; background:var(--white); border-radius:12px; padding:var(--space-4); border:1px solid var(--gray-200); }
        .trainer-card img { width:72px; height:72px; border-radius:50%; object-fit:cover; margin-bottom:var(--space-2); background:var(--gray-200); }
        .trainer-card h5 { font-family:var(--font-display); font-size:1rem; color:var(--navy); margin-bottom:2px; }
        .trainer-card .trainer-title { font-size:0.75rem; color:var(--red); font-weight:600; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:var(--space-1); }
        .trainer-card .trainer-cred { font-size:0.75rem; color:var(--gray-500); }
        /* Mini testimonial */
        .mini-testimonial { font-size:0.8125rem; font-style:italic; color:var(--gray-600); background:var(--gray-50); border:1px solid var(--gray-200); border-radius:10px; padding:var(--space-3); margin-bottom:var(--space-4); }
        .mini-testimonial .stars { color:#f59e0b; font-style:normal; font-size:0.75rem; display:block; margin-bottom:4px; }
        .mini-testimonial cite { font-size:0.75rem; color:var(--gray-500); font-style:normal; display:block; margin-top:4px; }
        /* Price comparison */
        .price-comparison { background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border:1px solid #f59e0b; border-radius:10px; padding:var(--space-3) var(--space-4); margin-top:var(--space-4); }
        .price-comparison .label { font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.04em; color:#92400e; margin-bottom:var(--space-2); }
        .price-comparison .row { display:flex; justify-content:space-between; font-size:0.8125rem; padding:4px 0; }
        .price-comparison .theirs { color:var(--gray-500); text-decoration:line-through; }
        .price-comparison .ours { color:var(--green); font-weight:700; }
        .price-comparison .highlight { font-size:0.8125rem; color:#92400e; font-weight:600; margin-top:var(--space-2); }
        /* Kit upsell offer */
        .kit-upsell-offer { background:var(--gray-50); border:2px solid var(--gray-200); border-radius:10px; padding:var(--space-3) var(--space-4); margin-top:var(--space-3); cursor:pointer; transition:border-color 0.15s; }
        .kit-upsell-offer.selected { border-color:var(--green); background:var(--green-light); }
        .kit-upsell-offer label { display:flex; align-items:start; gap:var(--space-2); cursor:pointer; font-size:0.875rem; color:var(--navy); }
        /* Video container */
        .funnel-video-container { position:relative; border-radius:12px; overflow:hidden; background:#000; margin-bottom:var(--space-4); }
        .funnel-video-container video, .funnel-video-container iframe { width:100%; display:block; aspect-ratio:16/9; }
        /* Team 2-step form */
        .team-step-indicator { display:flex; justify-content:center; gap:var(--space-2); margin-bottom:var(--space-4); }
        .team-step-dot { width:8px; height:8px; border-radius:50%; background:var(--gray-300); transition:background 0.2s; }
        .team-step-dot.active { background:var(--red); }
        /* Ask-a-question modal */
        .question-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:center; justify-content:center; padding:var(--space-4); opacity:0; visibility:hidden; transition:opacity 0.2s, visibility 0.2s; }
        .question-modal-overlay.open { opacity:1; visibility:visible; }
        .question-modal { background:white; border-radius:16px; max-width:480px; width:100%; padding:var(--space-6); position:relative; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.2); }
        .question-modal-close { position:absolute; top:var(--space-3); right:var(--space-3); background:none; border:none; cursor:pointer; color:var(--gray-400); padding:4px; }
        .question-modal-close:hover { color:var(--navy); }
        /* Case study card */
        .case-study-card { background:var(--white); border-radius:12px; padding:var(--space-4); border-left:4px solid var(--red); box-shadow:var(--shadow-sm); }
        .case-study-card h5 { font-size:0.875rem; color:var(--navy); margin-bottom:var(--space-2); }
        .case-study-card .cs-label { font-size:0.6875rem; font-weight:700; text-transform:uppercase; letter-spacing:0.04em; margin-bottom:2px; }
        .case-study-card .cs-text { font-size:0.8125rem; color:var(--gray-600); margin-bottom:var(--space-1); }
        /* Progress bar shimmer animation */
        .funnel-progress-fill {
            position: relative;
            overflow: hidden;
        }
        .funnel-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%);
            animation: progressShimmer 2s ease-in-out infinite;
        }
        @keyframes progressShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @media (max-width:640px) {
            .funnel-tooltip-trigger:hover::after, .funnel-tooltip-trigger:focus::after { left:0; transform:none; width:200px; }
            .trainer-card { padding:var(--space-3); }
        }
    </style>
</head>
<body>
    <!-- Funnel Header — minimal, no exit links -->
    <header class="header" id="header">
        <div class="container">
            <div class="header-inner">
                <div class="logo" style="pointer-events:none;">
                    <div class="logo-mark">+</div>
                    <div class="logo-text">
                        <span class="logo-name">Coral Sea Training</span>
                        <span class="logo-tagline">RTO #32221</span>
                    </div>
                </div>
                <nav class="nav" style="display:none;"></nav>
                <div class="header-actions">
                    <button onclick="openQuestionModal()" style="display:flex;align-items:center;gap:6px;background:none;border:none;cursor:pointer;font-family:var(--font-body);font-size:0.8125rem;font-weight:600;color:rgba(255,255,255,0.8);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        Have a question?
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Urgency Banner -->
    <div class="urgency-banner" id="urgencyBanner">
        <div class="container">
            <p class="urgency-text">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Next Townsville session &mdash; <a href="#" onclick="selectType('individual', document.querySelector('#step-type .funnel-option'));return false;">Reserve your spot</a>
            </p>
        </div>
    </div>

    <!-- Funnel Section -->
    <section class="funnel-section">
        <div class="container">
            <div class="funnel-wrapper">

                <!-- Progress Bar -->
                <div class="funnel-progress-wrapper">
                    <div class="funnel-progress-bar">
                        <div class="funnel-progress-fill" id="progressFill" style="width: 20%"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:6px;">
                        <span class="funnel-step-label" id="stepLabel">Step 1 of 5 — About You</span>
                        <span id="stepLabelName" style="font-size:0.75rem;color:var(--gray-500);font-weight:500;">Takes 30 seconds</span>
                    </div>
                </div>

                <!-- Choice Summary — fills as user progresses -->
                <div id="choiceSummary" style="display:none;margin-bottom:var(--space-3);">
                    <div id="choicePills" style="display:flex;flex-wrap:wrap;justify-content:center;gap:6px;"></div>
                </div>

                <!-- Social Proof Banner -->
                <div class="funnel-social-proof">
                    <span style="font-weight:700;color:var(--navy);">4.4&#9733; on Google</span>
                    <span style="color:var(--gray-400);">&bull;</span>
                    <span>RTO #32221</span>
                    <span style="color:var(--gray-400);">&bull;</span>
                    <span><strong>10,000+</strong> trained</span>
                </div>

                <!-- ===== STEP: Type (Individual or Team) ===== -->
                <div class="funnel-step active" id="step-type">
                    <div class="funnel-step-header">
                        <h1 class="funnel-title">Find Your Perfect Course in 30 Seconds</h1>
                        <p class="funnel-subtitle">Two quick taps and we'll recommend the exact certification you need.</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectType('individual', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Just Me</h3>
                                <p>Get certified fast &mdash; pick a date in under 60 seconds</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectType('team', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>My Team</h3>
                                <p>Reduce admin + keep everyone compliant (4+ staff)</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <!-- Trust reinforcement -->
                    <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:var(--space-2) var(--space-5);margin-top:var(--space-6);font-size:0.8125rem;color:var(--gray-500);">
                        <span style="display:flex;align-items:center;gap:4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;color:var(--green);"><polyline points="20 6 9 17 4 12"/></svg>
                            No account needed
                        </span>
                        <span style="display:flex;align-items:center;gap:4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;color:var(--green);"><polyline points="20 6 9 17 4 12"/></svg>
                            Free recommendation
                        </span>
                        <span style="display:flex;align-items:center;gap:4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;color:var(--green);"><polyline points="20 6 9 17 4 12"/></svg>
                            Pay on the day
                        </span>
                    </div>
                </div>

                <!-- ===== STEP: Industry (Individual path) ===== -->
                <div class="funnel-step" id="step-industry">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">Do You Work in Childcare or Education?</h2>
                        <p class="funnel-subtitle">This determines which certification you need.</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectIndustry('childcare', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Yes, Childcare / Education</h3>
                                <p>I need ACECQA-approved training</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectIndustry('other', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>No, Another Industry</h3>
                                <p>Workplace, personal, or general first aid</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Partner Business (Team path) ===== -->
                <div class="funnel-step" id="step-partner">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">Are You a Partner Business?</h2>
                        <p class="funnel-subtitle">Partner businesses get priority scheduling and exclusive rates.</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectPartner('yes', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Yes</h3>
                                <p>We're already a Coral Sea partner</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectPartner('interested', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>No, but I'd Like to Be</h3>
                                <p>Tell me about partner benefits</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Delivery (Team path) ===== -->
                <div class="funnel-step" id="step-delivery">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">Would You Like Us to Come to You?</h2>
                        <p class="funnel-subtitle">We bring all equipment &mdash; all you need is a room and your team.</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectDelivery('onsite', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Yes, Come to Our Workplace</h3>
                                <p>We bring everything to you &mdash; zero travel for your team</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectDelivery('venue', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>No, We'll Go to Your Venue</h3>
                                <p>Our team attends a scheduled course at your location</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Course Level (Individual non-childcare) ===== -->
                <div class="funnel-step" id="step-level">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">What Level of Training Do You Need?</h2>
                        <p class="funnel-subtitle">Not sure? Most employers require Provide First Aid (HLTAID011).</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectLevel('cpr', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Just CPR <span class="funnel-tooltip-trigger" data-tooltip="Best for your annual refresh when your workplace only requires CPR (HLTAID009). Renew annually. ~3 hours." aria-label="More info about CPR">&#9432;</span></h3>
                                <p>Annual refresh &mdash; 3 hours, in and out</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectLevel('firstaid', this)">
                            <div class="funnel-option-icon" style="background: var(--red-light);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--red);"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Full First Aid <span class="funnel-tooltip-trigger" data-tooltip="Most workplaces require this. Includes CPR + complete first-aid certification (HLTAID011). Valid 3 years. ~7 hours." aria-label="More info about Full First Aid">&#9432;</span></h3>
                                <p>CPR included &mdash; the complete workplace certification</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <p style="text-align:center;font-size:0.8125rem;color:var(--gray-500);margin-top:var(--space-2);">Not sure? Choose Full First Aid &mdash; it covers most employer requirements.</p>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Location ===== -->
                <div class="funnel-step" id="step-location">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">Which Location Works Best?</h2>
                        <p class="funnel-subtitle">Pick the venue closest to you.</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectLocation('townsville', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Townsville</h3>
                                <p>40 Charles St, Aitkenvale QLD 4814</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectLocation('widebay', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Wide Bay</h3>
                                <p>60 John St, Maryborough QLD 4650</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Urgency ===== -->
                <div class="funnel-step" id="step-urgency">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">How Soon Do You Need Training?</h2>
                        <p class="funnel-subtitle">We'll prioritise urgent bookings and find you the earliest spot.</p>
                    </div>

                    <div class="funnel-options funnel-options-2">
                        <button class="funnel-option" onclick="selectUrgency('asap', this)">
                            <div class="funnel-option-icon" style="background: var(--red-light);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--red);"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>Need Training Within a Week</h3>
                                <p>Urgent &mdash; I need this for work or compliance ASAP</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>

                        <button class="funnel-option" onclick="selectUrgency('flexible', this)">
                            <div class="funnel-option-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                            </div>
                            <div class="funnel-option-text">
                                <h3>I'm Flexible</h3>
                                <p>No rush &mdash; show me all available dates</p>
                            </div>
                            <div class="funnel-option-check">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                            </div>
                        </button>
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Your Offer ===== -->
                <div class="funnel-step" id="step-offer">
                    <div id="offerContent">
                        <!-- Populated by JavaScript -->
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Book Your Spot (Individual) ===== -->
                <div class="funnel-step" id="step-booking">
                    <div id="bookingContent">
                        <!-- Populated by JavaScript -->
                    </div>

                    <button class="funnel-back" onclick="goBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>

                <!-- ===== STEP: Booking Confirmed ===== -->
                <div class="funnel-step" id="step-confirmed">
                    <div id="confirmedContent">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Ask-a-Question Modal -->
    <div class="question-modal-overlay" id="questionModalOverlay" onclick="closeQuestionModal(event)">
        <div class="question-modal" onclick="event.stopPropagation()">
            <button class="question-modal-close" onclick="closeQuestionModal()" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <h3 style="font-family:var(--font-display);font-size:1.25rem;color:var(--navy);margin-bottom:var(--space-1);">Ask a Question</h3>
            <p style="font-size:0.8125rem;color:var(--gray-500);margin-bottom:var(--space-3);">We'll get back to you within 2 hours.</p>
            <div id="qContextDisplay" style="display:none;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:8px;padding:var(--space-2) var(--space-3);margin-bottom:var(--space-3);font-size:0.75rem;color:var(--gray-600);">
                <strong style="color:var(--navy);">You're asking about:</strong> <span id="qContextText"></span>
            </div>
            <form id="questionForm" onsubmit="submitQuestion(event)">
                <div class="funnel-form-group" style="margin-bottom:var(--space-3);">
                    <input type="text" id="qName" class="form-input" placeholder="Name *" aria-label="Your name" required>
                </div>
                <div class="funnel-form-group" style="margin-bottom:var(--space-3);">
                    <input type="email" id="qEmail" class="form-input" placeholder="Email *" aria-label="Email address" required>
                </div>
                <div class="funnel-form-group" style="margin-bottom:var(--space-3);">
                    <input type="tel" id="qPhone" class="form-input" placeholder="Phone (optional)" aria-label="Phone number">
                </div>
                <div class="funnel-form-group" style="margin-bottom:var(--space-3);">
                    <textarea id="qMessage" class="form-input" placeholder="Your question..." rows="3" aria-label="Your question" required style="resize:vertical;"></textarea>
                </div>
                <input type="hidden" id="qContext" name="context" value="">
                <button type="submit" class="btn btn-primary btn-lg" id="qSubmitBtn" style="width:100%;">Send Question</button>
            </form>
        </div>
    </div>

    <!-- Minimal funnel footer — no exit links -->
    <footer style="padding:var(--space-6) 0;text-align:center;font-size:0.75rem;color:var(--gray-400);border-top:1px solid var(--gray-200);">
        <div class="container">
            <p style="margin:0;">Coral Sea Training &bull; RTO #32221 &bull; Nationally Accredited &bull; &copy; 2026</p>
        </div>
    </footer>

    <script type="application/ld+json">
    [
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "CPR Course (HLTAID009)",
            "description": "Learn CPR and AED defibrillator use. Annual renewal. Approx. 3 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "99", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        },
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Provide First Aid (HLTAID011)",
            "description": "Complete workplace First Aid certification including CPR. Valid 3 years. Approx. 7 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "159", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        },
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Childcare First Aid (HLTAID012)",
            "description": "ACECQA-approved First Aid for childcare and education workers. Includes CPR, anaphylaxis, asthma. Approx. 8 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "199", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        },
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Advanced Resuscitation (HLTAID015)",
            "description": "Advanced resuscitation techniques for healthcare and emergency workers. Approx. 6 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "199", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        }
    ]
    </script>

    <script src="js/course-data.js"></script>
    <script src="js/main.js"></script>
    <script>
    // =====================================================
    // Dynamic urgency banner from course data
    // =====================================================
    (function() {
        var next = getNextDate('townsville');
        if (next) {
            var bannerLink = document.querySelector('#urgencyBanner .urgency-text');
            if (bannerLink) {
                // Try to get real seat count from session data
                function updateBannerWithSeats() {
                    var seatsInfo = '';
                    if (sessionData && sessionData.meta && sessionData.meta.showSeatCounts) {
                        var sessions = getSessionsForCourse('hltaid011', 'townsville');
                        if (sessions.length > 0 && sessions[0].seatsLeft) {
                            seatsInfo = ' &bull; ' + sessions[0].seatsLeft + ' seats left';
                        }
                    }
                    bannerLink.innerHTML =
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' +
                        'Next Townsville session: <strong>' + next.formatted + '</strong>' + seatsInfo + ' &mdash; <a href="#" onclick="selectType(\'individual\', document.querySelector(\'#step-type .funnel-option\'));return false;">Reserve your spot</a>';
                }
                // Try immediately if data loaded, retry after short delay
                if (sessionData) {
                    updateBannerWithSeats();
                } else {
                    bannerLink.innerHTML =
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' +
                        'Next Townsville session: <strong>' + next.formatted + '</strong> &mdash; <a href="#" onclick="selectType(\'individual\', document.querySelector(\'#step-type .funnel-option\'));return false;">Reserve your spot</a>';
                    setTimeout(updateBannerWithSeats, 1500);
                }
            }
        }
    })();

    // =====================================================
    // Lead Qualification Funnel — Binary Decision Tree
    // =====================================================

    var funnelData = {
        type: '',       // individual | team
        industry: '',   // childcare | other (individual path)
        level: '',      // cpr | firstaid (individual non-childcare path)
        partner: '',    // yes | interested (team path)
        delivery: '',   // onsite | venue (team path)
        location: '',   // townsville | widebay | onsite
        urgency: '',    // asap | flexible
        name: '',
        email: '',
        phone: '',
        company: ''
    };

    var currentRec = null;
    var stepHistory = [];
    var currentStepId = 'step-type';
    var sessionData = null;
    var selectedSession = null;
    var bookingMode = 'none'; // 'session_selected' | 'request_next_available' | 'none'
    var formStartTracked = false;

    // Fetch session data
    fetch('data/sessions.json')
        .then(function(r) { return r.json(); })
        .then(function(d) { sessionData = d; })
        .catch(function() { sessionData = null; });

    // Fetch additional data files
    var trainerData = null;
    var upsellData = null;
    var comparisonData = null;
    var childcareData = null;

    fetch('data/trainers.json').then(function(r){return r.json();}).then(function(d){trainerData=d;}).catch(function(){});
    fetch('data/upsell.json').then(function(r){return r.json();}).then(function(d){upsellData=d;}).catch(function(){});
    fetch('data/comparison.json').then(function(r){return r.json();}).then(function(d){comparisonData=d;}).catch(function(){});
    fetch('data/childcare.json').then(function(r){return r.json();}).then(function(d){childcareData=d;}).catch(function(){});

    var funnelConfig = null;
    var caseStudyData = null;
    var testimonialsMini = null;

    fetch('data/funnel-config.json').then(function(r){return r.json();}).then(function(d){funnelConfig=d;}).catch(function(){});
    fetch('data/case-studies.json').then(function(r){return r.json();}).then(function(d){caseStudyData=d;}).catch(function(){});
    fetch('data/testimonials-mini.json').then(function(r){return r.json();}).then(function(d){testimonialsMini=d;}).catch(function(){});

    // Get future sessions for a course + location from sessionData
    function getSessionsForCourse(courseCode, locationId) {
        if (!sessionData || !sessionData.courses) return [];
        var today = new Date().toISOString().slice(0, 10);
        for (var i = 0; i < sessionData.courses.length; i++) {
            var c = sessionData.courses[i];
            if (c.code.toLowerCase() === courseCode.toLowerCase() || c.id === courseCode.toLowerCase()) {
                var loc = c.locations[locationId];
                if (!loc || !loc.sessions) return [];
                return loc.sessions.filter(function(s) { return s.dateISO >= today; });
            }
        }
        return [];
    }

    // Get location details from sessionData
    function getSessionLocation(courseCode, locationId) {
        if (!sessionData || !sessionData.courses) return null;
        for (var i = 0; i < sessionData.courses.length; i++) {
            var c = sessionData.courses[i];
            if (c.code.toLowerCase() === courseCode.toLowerCase() || c.id === courseCode.toLowerCase()) {
                return c.locations[locationId] || null;
            }
        }
        return null;
    }

    // Build choice summary text from funnelData
    function buildChoiceSummary() {
        var parts = [];
        if (funnelData.type === 'team') {
            parts.push('Team training');
            if (funnelData.delivery === 'onsite') parts.push('On-site');
            else if (funnelData.delivery === 'venue') parts.push('At venue');
        } else {
            if (funnelData.industry === 'childcare') {
                parts.push('Childcare / Education');
            } else if (funnelData.level === 'cpr') {
                parts.push('CPR only');
            } else {
                parts.push('Full First Aid');
            }
        }
        if (funnelData.location === 'townsville') parts.push('Townsville');
        else if (funnelData.location === 'widebay') parts.push('Wide Bay');
        else if (funnelData.location === 'onsite') parts.push('Your workplace');
        if (funnelData.urgency === 'asap') parts.push('ASAP');
        else if (funnelData.urgency === 'flexible') parts.push('Flexible timing');
        return parts;
    }

    // GA4 helper
    function fireEvent(name, params) {
        if (typeof gtag !== 'undefined') {
            gtag('event', name, params || {});
        }
    }

    // HTML escape to prevent XSS in user-supplied data
    function esc(str) {
        var div = document.createElement('div');
        div.textContent = str || '';
        return div.innerHTML;
    }

    // ---- Navigation ----

    function navigateTo(stepId) {
        document.querySelectorAll('.funnel-step').forEach(function(s) {
            s.classList.remove('active');
        });
        document.getElementById(stepId).classList.add('active');
        stepHistory.push(currentStepId);
        currentStepId = stepId;
        updateProgress();
        updateChoiceSummary();
        updateWrapperWidth();
        fireEvent('quiz_step_view', { step_name: stepNameMap[stepId] || stepId });
        document.querySelector('.funnel-wrapper').scrollIntoView({ behavior: 'instant', block: 'start' });
    }

    function goBack() {
        if (stepHistory.length === 0) return;
        var prevStep = stepHistory.pop();
        document.querySelectorAll('.funnel-step').forEach(function(s) {
            s.classList.remove('active');
        });
        document.getElementById(prevStep).classList.add('active');
        currentStepId = prevStep;
        updateProgress();
        updateChoiceSummary();
        updateWrapperWidth();
        document.querySelector('.funnel-wrapper').scrollIntoView({ behavior: 'instant', block: 'start' });
    }

    function updateWrapperWidth() {
        var wrapper = document.querySelector('.funnel-wrapper');
        if (currentStepId === 'step-offer' || currentStepId === 'step-confirmed') {
            wrapper.classList.add('funnel-wrapper--wide');
        } else {
            wrapper.classList.remove('funnel-wrapper--wide');
        }
    }

    // Step name labels for progress bar
    var stepNameMap = {
        'step-type': 'About You',
        'step-industry': 'Industry',
        'step-level': 'Course Level',
        'step-partner': 'Partnership',
        'step-delivery': 'Delivery',
        'step-location': 'Location',
        'step-urgency': 'Timing',
        'step-offer': 'Your Course',
        'step-booking': 'Book Your Spot',
        'step-confirmed': 'Booked'
    };

    function updateProgress() {
        var stepsCompleted = stepHistory.length;
        var totalSteps = 5;
        if (funnelData.type === 'team') {
            totalSteps = (funnelData.delivery === 'onsite') ? 5 : 6;
        }

        var stepNameEl = document.getElementById('stepLabelName');

        if (currentStepId === 'step-confirmed') {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('stepLabel').textContent = 'Booked!';
            if (stepNameEl) stepNameEl.textContent = '';
        } else if (currentStepId === 'step-booking') {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('stepLabel').textContent = 'Almost done \u2014 pick your date';
            if (stepNameEl) stepNameEl.textContent = '';
        } else if (currentStepId === 'step-offer') {
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('stepLabel').textContent = 'Step ' + totalSteps + ' of ' + totalSteps + ' \u2014 Your recommendation';
            if (stepNameEl) stepNameEl.textContent = '';
        } else {
            var progress = ((stepsCompleted + 1) / totalSteps) * 100;
            document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
            var stepNum = stepsCompleted + 1;
            var stepName = stepNameMap[currentStepId] || '';
            document.getElementById('stepLabel').textContent = 'Step ' + stepNum + ' of ' + totalSteps + (stepName ? ' \u2014 ' + stepName : '');
            if (stepNameEl) stepNameEl.textContent = '';
        }
    }

    function updateChoiceSummary() {
        var container = document.getElementById('choiceSummary');
        var pills = document.getElementById('choicePills');
        if (!container || !pills) return;

        var items = [];
        if (funnelData.type === 'individual') items.push('Just Me');
        else if (funnelData.type === 'team') items.push('My Team');

        if (funnelData.type === 'individual') {
            if (funnelData.industry === 'childcare') items.push('Childcare');
            else if (funnelData.industry === 'other' && funnelData.level === 'cpr') items.push('CPR');
            else if (funnelData.industry === 'other' && funnelData.level === 'firstaid') items.push('First Aid');
            else if (funnelData.industry === 'other') items.push('Other industry');
        }
        if (funnelData.type === 'team') {
            if (funnelData.partner) items.push(funnelData.partner === 'yes' ? 'Partner' : 'Interested');
            if (funnelData.delivery === 'onsite') items.push('On-site');
            else if (funnelData.delivery === 'venue') items.push('At venue');
        }
        if (funnelData.location === 'townsville') items.push('Townsville');
        else if (funnelData.location === 'widebay') items.push('Wide Bay');
        else if (funnelData.location === 'onsite' && funnelData.type === 'individual') items.push('Your workplace');
        if (funnelData.urgency === 'asap') items.push('ASAP');
        else if (funnelData.urgency === 'flexible') items.push('Flexible');

        if (items.length === 0 || currentStepId === 'step-type' || currentStepId === 'step-offer' || currentStepId === 'step-booking' || currentStepId === 'step-confirmed') {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'block';
        pills.innerHTML = items.map(function(item) {
            return '<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:var(--green-light);color:var(--green);border-radius:100px;font-size:0.6875rem;font-weight:600;letter-spacing:0.02em;">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:10px;height:10px;"><polyline points="20 6 9 17 4 12"/></svg>' +
                esc(item) + '</span>';
        }).join('');
    }

    function highlightOption(btn) {
        var step = btn.closest('.funnel-step');
        step.querySelectorAll('.funnel-option').forEach(function(o) {
            o.classList.remove('selected');
        });
        btn.classList.add('selected');
    }

    // ---- Step Handlers ----

    function selectType(value, btn) {
        funnelData.type = value;
        highlightOption(btn);
        fireEvent('quiz_start');
        fireEvent('quiz_step_complete', { step_name: 'type', step_value: value });
        setTimeout(function() {
            if (value === 'individual') {
                navigateTo('step-industry');
            } else {
                navigateTo('step-partner');
            }
        }, 150);
    }

    function selectPartner(value, btn) {
        funnelData.partner = value;
        highlightOption(btn);
        fireEvent('quiz_step_complete', { step_name: 'partner', step_value: value });
        setTimeout(function() {
            navigateTo('step-delivery');
        }, 150);
    }

    function selectIndustry(value, btn) {
        funnelData.industry = value;
        highlightOption(btn);
        fireEvent('quiz_step_complete', { step_name: 'industry', step_value: value });
        setTimeout(function() {
            if (value === 'childcare') {
                navigateTo('step-location');
            } else {
                navigateTo('step-level');
            }
        }, 150);
    }

    function selectLevel(value, btn) {
        funnelData.level = value;
        highlightOption(btn);
        fireEvent('quiz_step_complete', { step_name: 'level', step_value: value });
        setTimeout(function() {
            navigateTo('step-location');
        }, 150);
    }

    function selectDelivery(value, btn) {
        funnelData.delivery = value;
        highlightOption(btn);
        fireEvent('quiz_step_complete', { step_name: 'delivery', step_value: value });
        setTimeout(function() {
            if (value === 'onsite') {
                funnelData.location = 'onsite';
                navigateTo('step-urgency');
            } else {
                navigateTo('step-location');
            }
        }, 150);
    }

    function selectLocation(value, btn) {
        funnelData.location = value;
        highlightOption(btn);
        fireEvent('quiz_step_complete', { step_name: 'location', step_value: value });
        setTimeout(function() {
            navigateTo('step-urgency');
        }, 150);
    }

    function selectUrgency(value, btn) {
        funnelData.urgency = value;
        highlightOption(btn);
        fireEvent('quiz_step_complete', { step_name: 'urgency', step_value: value });
        setTimeout(function() {
            showOffer();
        }, 150);
    }

    // ---- Offer Page ----

    function showOffer() {
        selectedSession = null;
        bookingMode = 'none';
        formStartTracked = false;
        currentRec = getRecommendation();
        document.getElementById('offerContent').innerHTML = buildOfferHTML(currentRec);
        navigateTo('step-offer');
        fireEvent('quiz_complete', { course_recommended: currentRec.code, location: funnelData.location, urgency: funnelData.urgency });
        fireEvent('results_view', { course_recommended: currentRec.code, location: funnelData.location });

        // Track form focus (team path has form on offer page; individual path has it on booking step)
        setTimeout(function() {
            var fields = document.querySelectorAll('#funnelName, #funnelEmail, #funnelPhone');
            fields.forEach(function(f) {
                f.addEventListener('focus', function() {
                    if (!formStartTracked) {
                        formStartTracked = true;
                        fireEvent('booking_form_start');
                    }
                });
            });

            // GA4: trainer section view (team path only now)
            var trainerEl = document.getElementById('trainerSection');
            if (trainerEl && typeof IntersectionObserver !== 'undefined') {
                var obs = new IntersectionObserver(function(entries) {
                    if (entries[0].isIntersecting) {
                        fireEvent('bio_view', { course: currentRec.code });
                        obs.disconnect();
                    }
                }, { threshold: 0.5 });
                obs.observe(trainerEl);
            }

            // GA4: upsell shown / order bump view
            var kitUpsellEl = document.getElementById('kitUpsellOffer');
            if (kitUpsellEl) {
                fireEvent('upsell_shown', { course: currentRec.code });
                fireEvent('order_bump_view', { course: currentRec.code });
            }
        }, 100);
    }

    function getRecommendation() {
        var rec = {};

        if (funnelData.type === 'team') {
            rec.isTeam = true;
            rec.code = 'Participant Credits';
            rec.badge = 'Team Packages';
            rec.description = 'Buy participant credits and use them on any course &mdash; CPR, First Aid, or Childcare. ' + (funnelData.delivery === 'onsite' ? 'We bring everything to your workplace.' : 'Book your team into scheduled courses at our venue.');
            rec.duration = funnelData.delivery === 'onsite' ? 'Flexible &mdash; tailored to your team' : '1 day per course';
            rec.validity = 'Credits valid 12 months';
            rec.upsellCourse = null;
            rec.packages = [
                {
                    name: 'Small Team Package',
                    badge: 'Most Popular',
                    credits: 8,
                    price: 1497,
                    priceLabel: '$1,497',
                    perHead: '$187',
                    savings: 'Save $275 vs individual bookings',
                    includes: [
                        '8 participant credits (use on any course)',
                        funnelData.delivery === 'onsite' ? 'On-site training &mdash; we bring everything' : 'Venue-based training at our facility',
                        'Compliance certificates for every participant',
                        '"Save a Life" Learning Vault for every team member ($179/head value)',
                        '100% Compliance Guarantee',
                        'Expiry tracking &amp; renewal reminders'
                    ]
                },
                {
                    name: 'Platinum Enterprise',
                    badge: 'Best Value',
                    credits: 25,
                    price: 2997,
                    priceLabel: '$2,997',
                    perHead: '$120',
                    savings: 'Save $978 vs individual bookings',
                    includes: [
                        '25 participant credits (use on any course)',
                        funnelData.delivery === 'onsite' ? 'On-site training &mdash; we bring everything' : 'Venue-based training at our facility',
                        'Dedicated training coordinator',
                        '12-month compliance management',
                        'Annual renewal auto-scheduling',
                        '"Save a Life" Learning Vault for every team member ($179/head value)',
                        '100% Compliance Guarantee',
                        '30% discount on additional credits'
                    ]
                }
            ];
            rec.course = 'Team Training Credits';
            rec.price = null;
            rec.priceLabel = 'From $120/person';
            rec.includes = rec.packages[0].includes;
            rec.bonuses = [
                '100% Compliance Guarantee &mdash; we manage everything until your team passes',
                '"Save a Life" Learning Vault for every team member ($179/head value) FREE',
                'Expiry tracking &amp; renewal reminders for your whole team',
                'Priority rescheduling if dates change'
            ];
            rec.btnText = 'Get My Team Quote';
        } else {
            rec.isTeam = false;
            if (funnelData.industry === 'childcare') {
                rec.course = 'The Educator Shield';
                rec.code = 'HLTAID012';
                rec.badge = 'Recommended For You';
                rec.price = 199;
                rec.priceLabel = '$199';
                rec.anchorPrice = '$400+';
                rec.description = 'The complete ACECQA-approved package &mdash; CPR, First Aid, Anaphylaxis and Asthma all in one day. Everything required for Cert III, Diploma, and educator roles.';
                rec.duration = 'Approx. 8 hours (1 day)';
                rec.validity = '3 years (CPR renewed annually)';
                rec.includes = [
                    'CPR & AED (HLTAID009)',
                    'Provide First Aid (HLTAID011)',
                    'Anaphylaxis management',
                    'Asthma emergency response',
                    'ACECQA approved for childcare',
                    'Statement of Attainment on completion'
                ];
                rec.bonuses = [
                    'Three qualifications in a single day (worth $400+ separately)',
                    'Meets all ACECQA &amp; centre licensing requirements',
                    '"Save a Life" Learning Vault &mdash; video refreshers &amp; quick-reference guides ($179 value) FREE',
                    '100% Skills Mastery Guarantee &mdash; retrain free if you don\'t feel confident'
                ];
                rec.btnText = 'Book Now &mdash; $199';
                rec.totalValue = '$697';
                rec.valueStackItems = [
                    { item: 'Childcare First Aid Course', value: '$199' },
                    { item: '"Save a Life" Learning Vault', value: '$179' },
                    { item: 'ACECQA Compliance Verification', value: '$120' },
                    { item: 'Free Refresher Session (within 3 months)', value: '$79' },
                    { item: 'Skills Mastery Guarantee (retrain free)', value: '$79' },
                    { item: 'Renewal Reminders &amp; Expiry Tracking', value: '$41' }
                ];
                rec.upsellCourse = null;
            } else if (funnelData.level === 'cpr') {
                rec.course = 'The 2-Hour Lifesaver';
                rec.code = 'HLTAID009';
                rec.badge = 'Quick &amp; Easy';
                rec.price = 99;
                rec.priceLabel = '$99';
                rec.anchorPrice = '$140+';
                rec.description = 'Quick 3-hour refresh &mdash; perfect for your annual CPR renewal. You\'ll practise on mannequins and AED defibrillators with hands-on guidance.';
                rec.duration = 'Approx. 3 hours';
                rec.validity = '12 months';
                rec.includes = [
                    'Cardiopulmonary Resuscitation (CPR)',
                    'AED Defibrillator Training',
                    'Infant, child &amp; adult techniques',
                    'Practical assessment with feedback',
                    'Statement of Attainment on completion'
                ];
                rec.bonuses = [
                    '"Save a Life" Learning Vault &mdash; video refreshers &amp; quick-reference guides ($179 value) FREE',
                    'Free refresher session within 3 months if you want extra practice',
                    'Renewal reminder before your cert expires &mdash; never lapse',
                    '100% Skills Mastery Guarantee &mdash; retrain free if you don\'t feel confident'
                ];
                rec.btnText = 'Book Now &mdash; $99';
                rec.totalValue = '$396';
                rec.valueStackItems = [
                    { item: 'CPR &amp; AED Training Course', value: '$99' },
                    { item: '"Save a Life" Learning Vault', value: '$179' },
                    { item: 'Free Refresher Session (within 3 months)', value: '$79' },
                    { item: 'Renewal Reminder Service', value: '$39' }
                ];
                rec.upsellCourse = {
                    name: 'The Complete First Aider (HLTAID011)',
                    price: '$159',
                    pitch: 'Upgrade to full First Aid for just $60 more &mdash; includes CPR plus comprehensive workplace skills. Valid 3 years instead of 1.'
                };
            } else {
                rec.course = 'The Complete First Aider';
                rec.code = 'HLTAID011';
                rec.badge = 'Most Popular';
                rec.price = 159;
                rec.priceLabel = '$159';
                rec.anchorPrice = '$260';
                rec.description = 'Our most popular course. Includes CPR certification bundled in, plus comprehensive first aid skills. Nationally recognised and meets all workplace compliance requirements.';
                rec.duration = 'Approx. 7 hours (1 day)';
                rec.validity = '3 years (CPR renewed annually)';
                rec.includes = [
                    'CPR & AED (HLTAID009) included',
                    'Wound management & bandaging',
                    'Burns, bites & stings',
                    'Fractures & dislocations',
                    'Medical emergencies',
                    'Statement of Attainment on completion'
                ];
                rec.bonuses = [
                    'Two qualifications in one day (CPR + First Aid &mdash; worth $260 separately)',
                    '"Save a Life" Learning Vault &mdash; video refreshers &amp; quick-reference guides ($179 value) FREE',
                    'Free refresher session within 3 months if you want extra practice',
                    'Renewal reminder before your cert expires &mdash; never lapse',
                    '100% Skills Mastery Guarantee &mdash; retrain free if you don\'t feel confident'
                ];
                rec.btnText = 'Book Now &mdash; $159';
                rec.totalValue = '$557';
                rec.valueStackItems = [
                    { item: 'First Aid + CPR Course (2-in-1)', value: '$159' },
                    { item: '"Save a Life" Learning Vault', value: '$179' },
                    { item: 'Free Refresher Session (within 3 months)', value: '$79' },
                    { item: 'Skills Mastery Guarantee (retrain free)', value: '$79' },
                    { item: 'Renewal Reminders &amp; Expiry Tracking', value: '$41' },
                    { item: 'Forward-to-Employer Certificate', value: '$20' }
                ];
                rec.upsellCourse = null;
            }
        }

        // Location display
        if (funnelData.location === 'townsville') {
            rec.locationDisplay = 'Townsville &mdash; 40 Charles St, Aitkenvale';
        } else if (funnelData.location === 'widebay') {
            rec.locationDisplay = 'Wide Bay &mdash; 60 John St, Maryborough';
        } else {
            rec.locationDisplay = 'On-site at your workplace';
        }

        if (funnelData.urgency === 'asap') {
            rec.urgencyNote = 'Only <strong>4 spots left</strong> on the next available course. We\'ll lock in yours now.';
        } else {
            rec.urgencyNote = 'We\'ll send you upcoming dates so you can pick the one that works best.';
        }

        return rec;
    }

    function buildOfferHTML(rec) {
        var checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--green);flex-shrink:0;"><polyline points="20 6 9 17 4 12"/></svg>';

        var includesHTML = '';
        for (var i = 0; i < rec.includes.length; i++) {
            includesHTML += '<div class="funnel-result-feature">' + checkSvg + '<span>' + rec.includes[i] + '</span></div>';
        }

        var bonusHTML = '';
        var bonusSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);flex-shrink:0;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>';
        for (var j = 0; j < rec.bonuses.length; j++) {
            bonusHTML += '<div class="funnel-result-feature">' + bonusSvg + '<span><strong>' + rec.bonuses[j] + '</strong></span></div>';
        }

        // Upsell banner for CPR-only bookings
        var upsellHTML = '';
        if (rec.upsellCourse) {
            upsellHTML = '' +
                '<div class="funnel-offer-upsell">' +
                    '<div class="funnel-offer-upsell-badge">Upgrade Available</div>' +
                    '<h4>' + rec.upsellCourse.name + ' &mdash; ' + rec.upsellCourse.price + '</h4>' +
                    '<p>' + rec.upsellCourse.pitch + '</p>' +
                    '<button class="btn btn-outline" onclick="upgradeToFirstAid()" style="margin-top:var(--space-3);width:100%;">Upgrade to The Complete First Aider &mdash; $159</button>' +
                '</div>';
        }

        var companyFieldHTML = rec.isTeam
            ? '<div class="funnel-form-group"><input type="text" id="funnelCompany" class="form-input" placeholder="Company / Organisation *"></div>'
            : '';

        // Team package cards
        var teamPackagesHTML = '';
        if (rec.packages) {
            teamPackagesHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4);margin-bottom:var(--space-6);">';
            for (var p = 0; p < rec.packages.length; p++) {
                var pkg = rec.packages[p];
                var isFeatured = p === 1;
                var pkgCheckSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;color:var(--green);flex-shrink:0;"><polyline points="20 6 9 17 4 12"/></svg>';
                var pkgIncludes = '';
                for (var pi = 0; pi < pkg.includes.length; pi++) {
                    pkgIncludes += '<div style="display:flex;align-items:start;gap:6px;font-size:0.8125rem;color:var(--gray-700);margin-bottom:4px;">' + pkgCheckSvg + '<span>' + pkg.includes[pi] + '</span></div>';
                }
                teamPackagesHTML += '' +
                    '<div style="border:2px solid ' + (isFeatured ? 'var(--red)' : 'var(--gray-200)') + ';border-radius:12px;padding:var(--space-4);position:relative;' + (isFeatured ? 'background:var(--red-light);' : '') + '">' +
                        '<div style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:' + (isFeatured ? 'var(--red)' : 'var(--navy)') + ';color:white;font-size:0.6875rem;font-weight:700;padding:2px 10px;border-radius:20px;text-transform:uppercase;white-space:nowrap;">' + pkg.badge + '</div>' +
                        '<h4 style="font-family:var(--font-heading);font-size:1.125rem;color:var(--navy);margin-top:var(--space-2);margin-bottom:var(--space-1);">' + pkg.name + '</h4>' +
                        '<div style="font-size:0.8125rem;color:var(--green);font-weight:700;margin-bottom:var(--space-2);">' + pkg.credits + ' participant credits</div>' +
                        '<div style="display:flex;align-items:baseline;gap:6px;margin-bottom:2px;">' +
                            '<span style="font-size:1.75rem;font-weight:800;color:var(--navy);">' + pkg.priceLabel + '</span>' +
                        '</div>' +
                        '<div style="font-size:0.75rem;color:var(--gray-500);margin-bottom:var(--space-1);">' + pkg.perHead + '/person &bull; ' + pkg.savings + '</div>' +
                        '<hr style="border:none;border-top:1px solid var(--gray-200);margin:var(--space-3) 0;">' +
                        pkgIncludes +
                    '</div>';
            }
            teamPackagesHTML += '</div>';
        }

        // Itemized value stack for individual offers
        var valueStackHTML = '';
        if (rec.valueStackItems && !rec.isTeam) {
            var stackRows = '';
            for (var v = 0; v < rec.valueStackItems.length; v++) {
                stackRows += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;' + (v < rec.valueStackItems.length - 1 ? 'border-bottom:1px solid var(--gray-200);' : '') + '">' +
                    '<span style="font-size:0.8125rem;color:var(--gray-700);">' + rec.valueStackItems[v].item + '</span>' +
                    '<span style="font-size:0.8125rem;font-weight:600;color:var(--gray-600);">' + rec.valueStackItems[v].value + '</span>' +
                '</div>';
            }
            valueStackHTML = '<div style="background:var(--gray-50);border:1px solid var(--gray-200);border-radius:10px;padding:var(--space-3) var(--space-4);margin-top:var(--space-4);">' +
                '<div style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--navy);margin-bottom:var(--space-2);">Everything You\'re Getting:</div>' +
                stackRows +
                '<div style="display:flex;justify-content:space-between;align-items:center;padding-top:var(--space-3);margin-top:var(--space-2);border-top:2px solid var(--navy);">' +
                    '<span style="font-size:0.875rem;font-weight:700;color:var(--gray-500);">Total Value</span>' +
                    '<span style="font-size:1.125rem;font-weight:800;color:var(--gray-400);text-decoration:line-through;">' + rec.totalValue + '</span>' +
                '</div>' +
                '<div style="display:flex;justify-content:space-between;align-items:center;padding-top:var(--space-1);">' +
                    '<span style="font-size:1rem;font-weight:800;color:var(--green);">Today\'s Price</span>' +
                    '<span style="font-size:1.5rem;font-weight:800;color:var(--green);">' + rec.priceLabel + '</span>' +
                '</div>' +
            '</div>';
        }

        // ---- Choice Summary ----
        var summaryParts = buildChoiceSummary();
        var summaryPills = '';
        for (var sp = 0; sp < summaryParts.length; sp++) {
            summaryPills += '<span style="display:inline-block;background:var(--gray-100);color:var(--navy);font-size:0.75rem;font-weight:600;padding:4px 12px;border-radius:20px;border:1px solid var(--gray-200);">' + summaryParts[sp] + '</span> ';
        }
        var choiceSummaryHTML = '<div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:var(--space-6);">' +
            '<span style="font-size:0.8125rem;color:var(--gray-500);align-self:center;">You selected:</span> ' +
            summaryPills +
        '</div>';

        // ---- Schedule Selection (individual path only) ----
        var scheduleHTML = '';
        if (!rec.isTeam && funnelData.location !== 'onsite') {
            var sessions = getSessionsForCourse(rec.code, funnelData.location);
            var showSeats = sessionData && sessionData.meta && sessionData.meta.showSeatCounts;
            var slaHours = (sessionData && sessionData.meta && sessionData.meta.confirmationSLAHours) || 2;

            fireEvent('session_list_view', { count_sessions: sessions.length });

            scheduleHTML += '<div style="margin-bottom:var(--space-4);">' +
                '<h4 style="font-family:var(--font-heading);font-size:1rem;color:var(--navy);margin-bottom:var(--space-3);">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;vertical-align:text-bottom;margin-right:4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
                    'Choose Your Date' +
                '</h4>';

            if (sessions.length > 0) {
                var maxShow = funnelData.urgency === 'flexible' ? 6 : 3;
                var initialShow = Math.min(sessions.length, funnelData.urgency === 'flexible' ? maxShow : 3);

                for (var si = 0; si < sessions.length; si++) {
                    var sess = sessions[si];
                    var hiddenClass = si >= initialShow ? ' style="display:none;" data-extra-session="true"' : '';
                    var seatLabel = showSeats
                        ? '<span style="font-size:0.75rem;font-weight:600;color:' + (sess.seatsLeft <= 4 ? 'var(--red)' : 'var(--green)') + ';">' + sess.seatsLeft + ' seats left</span>'
                        : '<span style="font-size:0.75rem;font-weight:600;color:var(--gray-500);">Limited seats</span>';

                    scheduleHTML += '<div class="session-card" data-session-id="' + sess.id + '" data-session-date="' + sess.dateISO + '" data-session-label="' + sess.label + ' ' + sess.start + '&ndash;' + sess.end + '" onclick="selectSessionCard(this)"' + hiddenClass + ' ' + (hiddenClass ? '' : 'style="') + 'cursor:pointer;border:2px solid var(--gray-200);border-radius:10px;padding:var(--space-3);margin-bottom:var(--space-2);transition:all 0.15s ease;background:white;display:flex;justify-content:space-between;align-items:center;">' +
                        '<div>' +
                            '<div style="font-weight:700;color:var(--navy);font-size:0.9375rem;">' + sess.label + '</div>' +
                            '<div style="font-size:0.8125rem;color:var(--gray-500);">' + sess.start + ' &ndash; ' + sess.end + '</div>' +
                        '</div>' +
                        seatLabel +
                    '</div>';
                }

                if (sessions.length > initialShow) {
                    scheduleHTML += '<button onclick="showMoreSessions(this)" style="background:none;border:none;color:var(--red);font-size:0.8125rem;font-weight:600;cursor:pointer;padding:var(--space-2) 0;width:100%;text-align:center;">Show ' + (sessions.length - initialShow) + ' more dates &darr;</button>';
                }
            } else {
                scheduleHTML += '<div style="text-align:center;padding:var(--space-4);background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-200);">' +
                    '<p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:var(--space-2);">No dates currently posted for this location.</p>' +
                '</div>';
            }

            // "Request next available" option
            scheduleHTML += '<div class="session-card" data-session-id="request_next" data-session-date="" data-session-label="Next available date" onclick="selectSessionCard(this)" style="cursor:pointer;border:2px dashed var(--gray-300);border-radius:10px;padding:var(--space-3);margin-top:var(--space-2);transition:all 0.15s ease;background:white;display:flex;justify-content:space-between;align-items:center;">' +
                '<div>' +
                    '<div style="font-weight:700;color:var(--navy);font-size:0.9375rem;">Request next available</div>' +
                    '<div style="font-size:0.8125rem;color:var(--gray-500);">We\'ll contact you with the next open date</div>' +
                '</div>' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--gray-400);flex-shrink:0;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>' +
            '</div>';

            scheduleHTML += '</div>';
        }

        // ---- Confirmation SLA ----
        var slaHours = (sessionData && sessionData.meta && sessionData.meta.confirmationSLAHours) || 2;
        var confirmText = 'Fast confirmation (within ' + slaHours + ' hours)';

        // ---- Phone number for secondary CTA ----
        var phoneNumber = funnelData.location === 'widebay' ? '0488 488 467' : '0419 675 022';
        var phoneTel = funnelData.location === 'widebay' ? '0488488467' : '0419675022';

        // ---- Dynamic urgency strip ----
        var urgencyStripHTML = '';
        if (!rec.isTeam && funnelData.location !== 'onsite') {
            var urgSessions = getSessionsForCourse(rec.code, funnelData.location);
            if (urgSessions.length > 0) {
                var nextSess = urgSessions[0];
                var showSeatsUrg = sessionData && sessionData.meta && sessionData.meta.showSeatCounts;
                if (showSeatsUrg && nextSess.seatsLeft <= 6) {
                    urgencyStripHTML = '<div class="funnel-offer-urgency-strip"><p>Only <strong>' + nextSess.seatsLeft + ' seats left</strong> for ' + nextSess.label + '. Reserve now.</p></div>';
                } else {
                    urgencyStripHTML = '<div class="funnel-offer-urgency-strip"><p>Limited seats. Sessions fill fast &mdash; reserve now.</p></div>';
                }
            } else {
                urgencyStripHTML = '<div class="funnel-offer-urgency-strip"><p>Request your preferred date and we\'ll get back to you within ' + slaHours + ' hours.</p></div>';
            }
        } else if (rec.isTeam) {
            urgencyStripHTML = '<div class="funnel-offer-urgency-strip"><p>' + rec.urgencyNote + '</p></div>';
        }

        // ---- Secondary CTAs ----
        var secondaryCTAHTML = '' +
            '<div style="display:flex;gap:var(--space-3);margin-top:var(--space-4);justify-content:center;flex-wrap:wrap;">' +
                '<a href="tel:' + phoneTel + '" onclick="fireEvent(\'call_click\',{location:funnelData.location});fireEvent(\'secondary_call_click\',{location:funnelData.location})" style="display:inline-flex;align-items:center;gap:6px;font-size:0.8125rem;color:var(--navy);font-weight:600;text-decoration:none;padding:8px 16px;border:1px solid var(--gray-200);border-radius:8px;background:white;transition:border-color 0.15s;">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>' +
                    'Prefer to call? ' + phoneNumber +
                '</a>' +
                '<a href="#" onclick="openQuestionModal();return false;" style="display:inline-flex;align-items:center;gap:6px;font-size:0.8125rem;color:var(--navy);font-weight:600;text-decoration:none;padding:8px 16px;border:1px solid var(--gray-200);border-radius:8px;background:white;transition:border-color 0.15s;">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' +
                    'Have a question?' +
                '</a>' +
            '</div>';

        // ---- Price Comparison ----
        var priceCompHTML = '';
        if (!rec.isTeam && comparisonData && comparisonData.courses && comparisonData.courses[rec.code]) {
            var comp = comparisonData.courses[rec.code];
            priceCompHTML = '<div class="price-comparison">' +
                '<div class="label">How We Compare</div>' +
                '<div class="row"><span>Typical provider:</span><span class="theirs">$' + comp.competitorPrice + ' &bull; ' + comp.competitorTimeOff + ' off work</span></div>' +
                '<div class="row"><span>Coral Sea Training:</span><span class="ours">$' + comp.oursPrice + ' &bull; ' + comp.oursTimeOff + '</span></div>' +
                '<div class="highlight">' + comp.highlight + '</div>' +
            '</div>';
        }

        // ---- Trainer Bios ----
        var trainerHTML = '';
        if (trainerData && trainerData.trainers && trainerData.trainers.length > 0) {
            var trainerCards = '';
            for (var ti = 0; ti < trainerData.trainers.length; ti++) {
                var t = trainerData.trainers[ti];
                var credBullets = '';
                for (var ci = 0; ci < t.credentials.length; ci++) {
                    credBullets += '<div class="trainer-cred">&bull; ' + t.credentials[ci] + '</div>';
                }
                trainerCards += '<div class="trainer-card">' +
                    '<div style="width:72px;height:72px;background:var(--gray-200);border-radius:50%;margin:0 auto var(--space-2);display:flex;align-items:center;justify-content:center;">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:32px;height:32px;color:var(--gray-400);"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' +
                    '</div>' +
                    '<h5>' + t.name + '</h5>' +
                    '<div class="trainer-title">' + t.title + (t.region ? ' &mdash; ' + t.region : '') + '</div>' +
                    credBullets +
                '</div>';
            }
            trainerHTML = '<div style="margin-top:var(--space-6);" id="trainerSection">' +
                '<h4 style="font-family:var(--font-display);font-size:1.125rem;color:var(--navy);text-align:center;margin-bottom:var(--space-4);">Meet Your Trainers</h4>' +
                '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:var(--space-3);">' +
                    trainerCards +
                '</div>' +
            '</div>';
        }

        // ---- Explainer Video (placeholder — hidden until real video supplied) ----
        var videoHTML = '<div class="funnel-video-container" id="funnelVideo" style="display:none;margin-top:var(--space-6);">' +
            '<video controls preload="none" poster="" style="width:100%;aspect-ratio:16/9;">' +
                '<source src="" type="video/mp4">' +
            '</video>' +
        '</div>';

        // ---- Mini Testimonial near form (from testimonials-mini.json or fallback) ----
        var miniT = null;
        if (testimonialsMini && testimonialsMini.testimonials && testimonialsMini.testimonials.length > 0) {
            var tIdx = Math.floor(Math.random() * testimonialsMini.testimonials.length);
            miniT = testimonialsMini.testimonials[tIdx];
        }
        var miniTestimonialHTML = '<div class="mini-testimonial">' +
            '<span class="stars">&#9733;&#9733;&#9733;&#9733;&#9733;</span>' +
            '&ldquo;' + (miniT ? miniT.quote : 'Best first aid course I\'ve done. Relaxed, practical, and I actually feel ready to help now.') + '&rdquo;' +
            '<cite>&mdash; ' + (miniT ? miniT.author + ', ' + miniT.source : 'Mark T., Google Review') + '</cite>' +
        '</div>';

        // ---- Kit Upsell Checkbox ----
        var kitUpsellHTML = '';
        if (!rec.isTeam && upsellData && upsellData.kit) {
            var kit = upsellData.kit;
            kitUpsellHTML = '<div class="kit-upsell-offer" id="kitUpsellOffer" onclick="toggleKitUpsell()">' +
                '<label>' +
                    '<input type="checkbox" id="kitUpsellCheck" style="margin-top:3px;flex-shrink:0;" onclick="event.stopPropagation();toggleKitUpsell()">' +
                    '<div>' +
                        '<strong>Add a ' + kit.name + ' for ' + kit.priceLabel + '</strong>' +
                        '<div style="font-size:0.75rem;color:var(--gray-500);margin-top:2px;">' + kit.description + '</div>' +
                    '</div>' +
                '</label>' +
            '</div>';
        }

        // ---- Childcare enhanced description ----
        var childcareExtraHTML = '';
        if (!rec.isTeam && funnelData.industry === 'childcare' && childcareData) {
            var extraItems = '';
            if (childcareData.extras) {
                for (var ce = 0; ce < childcareData.extras.length; ce++) {
                    extraItems += '<div style="display:flex;align-items:start;gap:6px;font-size:0.8125rem;color:var(--gray-700);margin-bottom:4px;">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;color:var(--green);flex-shrink:0;"><polyline points="20 6 9 17 4 12"/></svg>' +
                        '<span>' + childcareData.extras[ce] + '</span></div>';
                }
            }
            childcareExtraHTML = '<div style="background:#ecfdf5;border:1px solid var(--green);border-radius:10px;padding:var(--space-3) var(--space-4);margin-top:var(--space-4);">' +
                '<div style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.04em;color:var(--green);margin-bottom:var(--space-2);">ACECQA Compliance</div>' +
                extraItems +
                (childcareData.complianceNote ? '<p style="font-size:0.75rem;color:var(--gray-500);margin-top:var(--space-2);font-style:italic;">' + childcareData.complianceNote + '</p>' : '') +
            '</div>';
        }

        // ---- Case Study for Team Path (B2) ----
        var caseStudyHTML = '';
        if (rec.isTeam && caseStudyData && caseStudyData.caseStudies && caseStudyData.caseStudies.length > 0) {
            var cs = caseStudyData.caseStudies[0]; // Show first case study
            caseStudyHTML = '<div class="case-study-card" style="margin-bottom:var(--space-4);">' +
                '<h5>' + cs.title + '</h5>' +
                '<div class="cs-label" style="color:var(--red);">Before</div>' +
                '<div class="cs-text">' + cs.before + '</div>' +
                '<div class="cs-label" style="color:var(--green);">After</div>' +
                '<div class="cs-text">' + cs.after + '</div>' +
                '<div class="cs-label" style="color:var(--navy);">Time to implement</div>' +
                '<div class="cs-text" style="font-weight:600;">' + cs.timeToImplement + '</div>' +
            '</div>';
        }

        // ---- "Book a 10-min call" CTA for Team Path (E2) ----
        var callCTAHTML = '';
        if (rec.isTeam) {
            callCTAHTML = '<div style="text-align:center;padding:var(--space-3);border:1px solid var(--gray-200);border-radius:10px;margin-top:var(--space-3);background:var(--gray-50);">' +
                '<p style="font-size:0.8125rem;color:var(--gray-600);margin-bottom:var(--space-2);">Prefer to discuss your team\'s needs?</p>' +
                '<a href="tel:' + phoneTel + '" onclick="fireEvent(\'corporate_calendar_click\',{location:funnelData.location})" style="display:inline-flex;align-items:center;gap:6px;font-size:0.875rem;color:var(--navy);font-weight:700;text-decoration:none;">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg>' +
                    'Book a 10-min Call &mdash; ' + phoneNumber +
                '</a>' +
            '</div>';
        }

        // ---- Membership Interest Capture (D3) ----
        var membershipHTML = '';
        if (!rec.isTeam) {
            membershipHTML = '<div style="background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border:1px solid #7dd3fc;border-radius:10px;padding:var(--space-3) var(--space-4);margin-top:var(--space-3);cursor:pointer;" onclick="toggleMembership()" id="membershipOffer">' +
                '<label style="display:flex;align-items:start;gap:var(--space-2);cursor:pointer;font-size:0.875rem;color:var(--navy);">' +
                    '<input type="checkbox" id="membershipCheck" style="margin-top:3px;flex-shrink:0;" onclick="event.stopPropagation();toggleMembership()">' +
                    '<div>' +
                        '<strong>Annual Refresh Club &mdash; $49/yr</strong>' +
                        '<div style="font-size:0.75rem;color:var(--gray-500);margin-top:2px;">Auto renewal reminders, refresher videos, and 15% off kits. We\'ll follow up with details.</div>' +
                    '</div>' +
                '</label>' +
            '</div>';
        }

        // ---- Team 2-step form ----
        var teamFormHTML = '';
        if (rec.isTeam) {
            teamFormHTML = '' +
                '<div class="team-step-indicator"><div class="team-step-dot active" id="teamDot1"></div><div class="team-step-dot" id="teamDot2"></div></div>' +
                '<div id="teamFormStep1">' +
                    '<div class="funnel-form-group"><input type="text" id="funnelName" class="form-input" placeholder="Contact name *" aria-label="Contact name" required></div>' +
                    '<div class="funnel-form-group"><input type="email" id="funnelEmail" class="form-input" placeholder="Work email *" aria-label="Work email" required></div>' +
                    '<div class="funnel-form-group"><input type="tel" id="funnelPhone" class="form-input" placeholder="Phone *" aria-label="Phone number" required></div>' +
                    '<div class="funnel-form-group"><input type="text" id="funnelCompany" class="form-input" placeholder="Company / Organisation *" aria-label="Company name" required></div>' +
                    '<button class="btn btn-primary btn-lg" onclick="teamFormNext()" style="width:100%;">Next: Team Details <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>' +
                '</div>' +
                '<div id="teamFormStep2" style="display:none;">' +
                    '<div class="funnel-form-group">' +
                        '<select id="funnelTeamSize" class="form-select" aria-label="Team size">' +
                            '<option value="">Team size *</option>' +
                            '<option value="4-8">4-8 people</option>' +
                            '<option value="9-15">9-15 people</option>' +
                            '<option value="16-25">16-25 people</option>' +
                            '<option value="26-50">26-50 people</option>' +
                            '<option value="50+">50+ people</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="funnel-form-group"><input type="text" id="funnelDates" class="form-input" placeholder="Preferred dates (optional)" aria-label="Preferred training dates"></div>' +
                    '<div class="funnel-form-group"><textarea id="funnelNotes" class="form-input" placeholder="Anything else we should know?" rows="2" aria-label="Additional notes" style="resize:vertical;"></textarea></div>' +
                    // "What happens next" block (pre-submission)
                    '<div style="background:var(--gray-50);border:1px solid var(--gray-200);border-radius:10px;padding:var(--space-3) var(--space-4);margin-bottom:var(--space-3);">' +
                        '<div style="font-size:0.8125rem;font-weight:700;color:var(--navy);margin-bottom:var(--space-2);">What happens next</div>' +
                        '<div style="display:flex;align-items:start;gap:6px;font-size:0.8125rem;color:var(--gray-600);margin-bottom:4px;">' +
                            '<span style="font-weight:700;color:var(--red);flex-shrink:0;">1.</span> We reply within 2 hours with a tailored quote</div>' +
                        '<div style="display:flex;align-items:start;gap:6px;font-size:0.8125rem;color:var(--gray-600);margin-bottom:4px;">' +
                            '<span style="font-weight:700;color:var(--red);flex-shrink:0;">2.</span> We confirm dates, headcount, and venue</div>' +
                        '<div style="display:flex;align-items:start;gap:6px;font-size:0.8125rem;color:var(--gray-600);">' +
                            '<span style="font-weight:700;color:var(--red);flex-shrink:0;">3.</span> Your compliance reminders are handled from day one</div>' +
                    '</div>' +
                    (funnelData.partner === 'yes' ? '<p style="font-size:0.75rem;color:var(--green);font-weight:600;text-align:center;margin-bottom:var(--space-3);">&#10003; Partners get priority booking windows + consolidated invoicing</p>' : '') +
                    '<div style="display:flex;gap:var(--space-2);">' +
                        '<button class="btn btn-outline" onclick="teamFormBack()" style="flex:0 0 auto;">Back</button>' +
                        '<button class="btn btn-primary btn-lg funnel-submit" id="funnelSubmitBtn" onclick="submitBooking()" style="flex:1;">Get My Team Quote <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>' +
                    '</div>' +
                '</div>';
        }

        // ---- Build card HTML (shared between paths) ----
        var cardHTML = '<div class="funnel-result-card" style="margin-bottom:0;">' +
            '<div class="funnel-result-badge">' + rec.badge + '</div>' +
            '<h3 class="funnel-result-course">' + rec.course + '</h3>' +
            (rec.code ? '<p style="font-size:0.8125rem;color:var(--gray-500);margin-top:2px;">' + rec.code + '</p>' : '') +
            '<div class="funnel-offer-price">' +
                (rec.anchorPrice ? '<span class="funnel-offer-price-anchor"><s>' + rec.anchorPrice + '</s> if bought separately</span>' : '') +
                '<span class="funnel-offer-price-amount">' + rec.priceLabel + '</span>' +
                '<span class="funnel-offer-price-sub">per person &bull; pay on the day</span>' +
            '</div>' +
            valueStackHTML +
            childcareExtraHTML +
            '<div class="funnel-offer-meta-strip">' +
                '<div class="funnel-offer-meta-item">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' +
                    '<span>' + rec.duration + '</span>' +
                '</div>' +
                '<div class="funnel-offer-meta-item">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>' +
                    '<span>Valid ' + rec.validity + '</span>' +
                '</div>' +
                '<div class="funnel-offer-meta-item">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' +
                    '<span>' + rec.locationDisplay + '</span>' +
                '</div>' +
            '</div>' +
            '<div class="funnel-offer-guarantee-strip">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>' +
                '<span><strong>100% Skills Mastery Guarantee</strong> &mdash; 98% pass first time. Don\'t feel confident? Come back and retrain free.</span>' +
            '</div>' +
        '</div>';

        // ---- Build final HTML ----
        var html = '' +
            '<div class="funnel-step-header">' +
                '<h2 class="funnel-title">Here\'s Your Perfect Match</h2>' +
                '<p class="funnel-subtitle">Based on your answers, this is the exact course you need.</p>' +
            '</div>' +
            choiceSummaryHTML;

        if (rec.isTeam) {
            // Team path: packages + form in two-column layout (unchanged)
            html += (teamPackagesHTML ? teamPackagesHTML : '') +
                '<div class="funnel-offer-layout">' +
                    '<div class="funnel-offer-main">' + cardHTML + '</div>' +
                    '<div class="funnel-offer-sidebar">' +
                        '<div class="funnel-offer-form-card">' +
                            '<h3 class="funnel-offer-form-title">Get Your Team Quote</h3>' +
                            '<p class="funnel-offer-form-sub">No study required. ' + confirmText + '. Pay on the day.</p>' +
                            miniTestimonialHTML +
                            caseStudyHTML +
                            teamFormHTML +
                            '<div class="funnel-offer-form-trust">' +
                                '<span>&#10003; ' + confirmText + '</span>' +
                                '<span>&#10003; Pay on the day</span>' +
                                '<span>&#10003; Forward to employer</span>' +
                            '</div>' +
                            callCTAHTML +
                        '</div>' +
                        urgencyStripHTML +
                        secondaryCTAHTML +
                    '</div>' +
                '</div>';
        } else {
            // Individual path: centered card + "Yes — Book This Course" CTA
            html += '<div style="max-width:560px;margin:0 auto;">' +
                cardHTML +
                '<div style="margin-top:var(--space-4);">' + miniTestimonialHTML + '</div>' +
                '<button class="btn btn-primary btn-lg" onclick="confirmCourse()" style="width:100%;font-size:1.125rem;margin-top:var(--space-4);">' +
                    'Yes \u2014 Book This Course ' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>' +
                '</button>' +
                '<p style="text-align:center;font-size:0.75rem;color:var(--gray-500);margin-top:var(--space-2);">No payment required now. Pay on the day.</p>' +
            '</div>';
        }

        return html;
    }

    // ---- Booking Step (Individual path) ----

    function buildBookingHTML(rec) {
        var slaHours = (sessionData && sessionData.meta && sessionData.meta.confirmationSLAHours) || 2;
        var confirmText = 'Fast confirmation (within ' + slaHours + ' hours)';
        var phoneNumber = funnelData.location === 'widebay' ? '0488 488 467' : '0419 675 022';
        var phoneTel = funnelData.location === 'widebay' ? '0488488467' : '0419675022';

        // Schedule selection
        var sessions = getSessionsForCourse(rec.code, funnelData.location);
        var showSeats = sessionData && sessionData.meta && sessionData.meta.showSeatCounts;
        fireEvent('session_list_view', { count_sessions: sessions.length });

        var scheduleHTML = '<div style="margin-bottom:var(--space-4);">' +
            '<h4 style="font-family:var(--font-heading);font-size:1rem;color:var(--navy);margin-bottom:var(--space-3);">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;vertical-align:text-bottom;margin-right:4px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
                'Choose Your Date' +
            '</h4>';

        if (sessions.length > 0) {
            var initialShow = Math.min(sessions.length, funnelData.urgency === 'flexible' ? 6 : 3);
            var baseStyle = 'cursor:pointer;border:2px solid var(--gray-200);border-radius:10px;padding:var(--space-3);margin-bottom:var(--space-2);transition:all 0.15s ease;background:white;display:flex;justify-content:space-between;align-items:center;';

            for (var si = 0; si < sessions.length; si++) {
                var sess = sessions[si];
                var isHidden = si >= initialShow;
                var seatLabel = showSeats
                    ? '<span style="font-size:0.75rem;font-weight:600;color:' + (sess.seatsLeft <= 4 ? 'var(--red)' : 'var(--green)') + ';">' + sess.seatsLeft + ' seats left</span>'
                    : '<span style="font-size:0.75rem;font-weight:600;color:var(--gray-500);">Limited seats</span>';

                scheduleHTML += '<div class="session-card" data-session-id="' + sess.id + '" data-session-date="' + sess.dateISO + '" data-session-label="' + sess.label + ' ' + sess.start + '&ndash;' + sess.end + '" onclick="selectSessionCard(this)"' + (isHidden ? ' data-extra-session="true"' : '') + ' style="' + (isHidden ? 'display:none;' : '') + baseStyle + '">' +
                    '<div>' +
                        '<div style="font-weight:700;color:var(--navy);font-size:0.9375rem;">' + sess.label + '</div>' +
                        '<div style="font-size:0.8125rem;color:var(--gray-500);">' + sess.start + ' &ndash; ' + sess.end + '</div>' +
                    '</div>' +
                    seatLabel +
                '</div>';
            }

            if (sessions.length > initialShow) {
                scheduleHTML += '<button onclick="showMoreSessions(this)" style="background:none;border:none;color:var(--red);font-size:0.8125rem;font-weight:600;cursor:pointer;padding:var(--space-2) 0;width:100%;text-align:center;">Show ' + (sessions.length - initialShow) + ' more dates &darr;</button>';
            }
        } else {
            scheduleHTML += '<div style="text-align:center;padding:var(--space-4);background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-200);">' +
                '<p style="font-size:0.875rem;color:var(--gray-600);margin-bottom:var(--space-2);">No dates currently posted for this location.</p>' +
            '</div>';
        }

        // "Request next available" option
        scheduleHTML += '<div class="session-card" data-session-id="request_next" data-session-date="" data-session-label="Next available date" onclick="selectSessionCard(this)" style="cursor:pointer;border:2px dashed var(--gray-300);border-radius:10px;padding:var(--space-3);margin-top:var(--space-2);transition:all 0.15s ease;background:white;display:flex;justify-content:space-between;align-items:center;">' +
            '<div>' +
                '<div style="font-weight:700;color:var(--navy);font-size:0.9375rem;">Request next available</div>' +
                '<div style="font-size:0.8125rem;color:var(--gray-500);">We\'ll contact you with the next open date</div>' +
            '</div>' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--gray-400);flex-shrink:0;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>' +
        '</div>';
        scheduleHTML += '</div>';

        // Urgency strip
        var urgencyStripHTML = '';
        if (sessions.length > 0) {
            var nextSess = sessions[0];
            if (showSeats && nextSess.seatsLeft <= 6) {
                urgencyStripHTML = '<div class="funnel-offer-urgency-strip"><p>Only <strong>' + nextSess.seatsLeft + ' seats left</strong> for ' + nextSess.label + '. Reserve now.</p></div>';
            } else {
                urgencyStripHTML = '<div class="funnel-offer-urgency-strip"><p>Limited seats. Sessions fill fast &mdash; reserve now.</p></div>';
            }
        }

        // Secondary CTAs
        var secondaryCTAHTML = '' +
            '<div style="display:flex;gap:var(--space-3);margin-top:var(--space-4);justify-content:center;flex-wrap:wrap;">' +
                '<a href="tel:' + phoneTel + '" onclick="fireEvent(\'call_click\',{location:funnelData.location});fireEvent(\'secondary_call_click\',{location:funnelData.location})" style="display:inline-flex;align-items:center;gap:6px;font-size:0.8125rem;color:var(--navy);font-weight:600;text-decoration:none;padding:8px 16px;border:1px solid var(--gray-200);border-radius:8px;background:white;transition:border-color 0.15s;">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>' +
                    'Prefer to call? ' + phoneNumber +
                '</a>' +
                '<a href="#" onclick="openQuestionModal();return false;" style="display:inline-flex;align-items:center;gap:6px;font-size:0.8125rem;color:var(--navy);font-weight:600;text-decoration:none;padding:8px 16px;border:1px solid var(--gray-200);border-radius:8px;background:white;transition:border-color 0.15s;">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' +
                    'Have a question?' +
                '</a>' +
            '</div>';

        return '' +
            '<div class="funnel-step-header">' +
                '<h2 class="funnel-title">Book Your Spot</h2>' +
                '<p class="funnel-subtitle">' + esc(rec.course) + ' (' + esc(rec.code) + ') &mdash; ' + esc(rec.priceLabel) + ' &bull; pay on the day</p>' +
            '</div>' +
            '<div style="max-width:480px;margin:0 auto;">' +
                scheduleHTML +
                '<div class="funnel-form-group">' +
                    '<input type="text" id="funnelName" class="form-input" placeholder="Full name *" aria-label="Full name" required>' +
                '</div>' +
                '<div class="funnel-form-row">' +
                    '<div class="funnel-form-group">' +
                        '<input type="email" id="funnelEmail" class="form-input" placeholder="Email *" aria-label="Email address" required>' +
                    '</div>' +
                    '<div class="funnel-form-group">' +
                        '<input type="tel" id="funnelPhone" class="form-input" placeholder="Phone (optional)" aria-label="Phone number">' +
                    '</div>' +
                '</div>' +
                '<button class="btn btn-primary btn-lg funnel-submit" id="funnelSubmitBtn" onclick="submitBooking()" style="width:100%;font-size:1.125rem;" disabled>' +
                    'Select a date above' +
                    ' <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>' +
                '</button>' +
                '<p style="text-align:center;font-size:0.75rem;color:var(--gray-500);margin-top:var(--space-2);">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:14px;height:14px;vertical-align:text-bottom;margin-right:2px;color:var(--green);"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>' +
                    'Skills Mastery Guarantee: retrain free if you\'re not confident.' +
                '</p>' +
                '<div class="funnel-offer-form-trust">' +
                    '<span>&#10003; ' + confirmText + '</span>' +
                    '<span>&#10003; Pay on the day</span>' +
                    '<span>&#10003; Forward to employer</span>' +
                '</div>' +
            '</div>' +
            urgencyStripHTML +
            secondaryCTAHTML;
    }

    function confirmCourse() {
        selectedSession = null;
        bookingMode = 'none';
        formStartTracked = false;
        fireEvent('course_confirmed', { course: currentRec.code, price: currentRec.price || 0 });
        document.getElementById('bookingContent').innerHTML = buildBookingHTML(currentRec);
        navigateTo('step-booking');

        // Track form focus
        setTimeout(function() {
            var fields = document.querySelectorAll('#funnelName, #funnelEmail, #funnelPhone');
            fields.forEach(function(f) {
                f.addEventListener('focus', function() {
                    if (!formStartTracked) {
                        formStartTracked = true;
                        fireEvent('booking_form_start');
                    }
                });
            });
        }, 100);
    }

    // ---- Session Card Selection ----

    function selectSessionCard(card) {
        // Deselect all
        document.querySelectorAll('.session-card').forEach(function(c) {
            c.style.borderColor = c.dataset.sessionId === 'request_next' ? 'var(--gray-300)' : 'var(--gray-200)';
            c.style.background = 'white';
        });
        // Select this one
        card.style.borderColor = 'var(--red)';
        card.style.background = 'var(--red-light)';

        var sessionId = card.dataset.sessionId;
        var btn = document.getElementById('funnelSubmitBtn');

        if (sessionId === 'request_next') {
            selectedSession = null;
            bookingMode = 'request_next_available';
            btn.disabled = false;
            btn.innerHTML = 'Request Next Available <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
        } else {
            selectedSession = {
                id: sessionId,
                dateISO: card.dataset.sessionDate,
                label: card.dataset.sessionLabel
            };
            bookingMode = 'session_selected';
            btn.disabled = false;
            btn.innerHTML = 'Reserve This Spot <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>';
            fireEvent('session_selected', { session_id: sessionId, dateISO: card.dataset.sessionDate });
        }
    }

    function showMoreSessions(btn) {
        document.querySelectorAll('[data-extra-session]').forEach(function(el) {
            el.style.display = 'flex';
            el.removeAttribute('data-extra-session');
        });
        btn.style.display = 'none';
    }

    // Upgrade from CPR to First Aid (upsell)
    function upgradeToFirstAid() {
        funnelData.level = 'firstaid';
        showOffer();
    }

    // ---- Team 2-Step Form ----

    function teamFormNext() {
        var name = document.getElementById('funnelName').value.trim();
        var email = document.getElementById('funnelEmail').value.trim();
        var phone = document.getElementById('funnelPhone').value.trim();
        var company = document.getElementById('funnelCompany').value.trim();
        if (!name) { shakeField('funnelName'); return; }
        if (!email || email.indexOf('@') === -1) { shakeField('funnelEmail'); return; }
        if (!phone) { shakeField('funnelPhone'); return; }
        if (!company) { shakeField('funnelCompany'); return; }

        document.getElementById('teamFormStep1').style.display = 'none';
        document.getElementById('teamFormStep2').style.display = 'block';
        document.getElementById('teamDot1').classList.remove('active');
        document.getElementById('teamDot1').style.background = 'var(--green)';
        document.getElementById('teamDot2').classList.add('active');
        fireEvent('team_step1_complete');
    }

    function teamFormBack() {
        document.getElementById('teamFormStep2').style.display = 'none';
        document.getElementById('teamFormStep1').style.display = 'block';
        document.getElementById('teamDot2').classList.remove('active');
        document.getElementById('teamDot2').style.background = 'var(--gray-300)';
        document.getElementById('teamDot1').classList.add('active');
        document.getElementById('teamDot1').style.background = 'var(--red)';
    }

    // ---- Question Modal (G1) ----

    function openQuestionModal() {
        fireEvent('question_modal_open');
        // Build context from current quiz state
        var ctxParts = [];
        var ctxFull = '';
        if (currentRec) {
            ctxParts.push(currentRec.course + ' (' + currentRec.code + ')');
            ctxFull = 'Course: ' + currentRec.course + ' (' + currentRec.code + ')';
            if (funnelData.location) {
                var locLabel = funnelData.location === 'townsville' ? 'Townsville' : (funnelData.location === 'widebay' ? 'Wide Bay' : funnelData.location);
                ctxParts.push(locLabel);
                ctxFull += ' | Location: ' + locLabel;
            }
            if (selectedSession) {
                ctxParts.push(selectedSession.label);
                ctxFull += ' | Session: ' + selectedSession.label;
            }
            if (funnelData.urgency) {
                var urgLabel = funnelData.urgency === 'asap' ? 'Need within a week' : 'Flexible';
                ctxParts.push(urgLabel);
                ctxFull += ' | Urgency: ' + urgLabel;
            }
        }
        // Set hidden context field
        var ctxInput = document.getElementById('qContext');
        if (ctxInput) ctxInput.value = ctxFull;
        // Show visible context confirmation
        var ctxDisplay = document.getElementById('qContextDisplay');
        var ctxText = document.getElementById('qContextText');
        if (ctxDisplay && ctxText && ctxParts.length > 0) {
            ctxText.textContent = ctxParts.join(' \u2022 ');
            ctxDisplay.style.display = 'block';
        } else if (ctxDisplay) {
            ctxDisplay.style.display = 'none';
        }
        // Prefill message with context summary
        var msgEl = document.getElementById('qMessage');
        if (msgEl && !msgEl.value && ctxParts.length > 0) {
            msgEl.value = 'Hi, I\'m looking at: ' + ctxParts.join(', ') + '. My question is: ';
        }
        // Prefill name/email if already entered in booking form
        var nameEl = document.getElementById('funnelName');
        var emailEl = document.getElementById('funnelEmail');
        if (nameEl && nameEl.value) document.getElementById('qName').value = nameEl.value;
        if (emailEl && emailEl.value) document.getElementById('qEmail').value = emailEl.value;
        document.getElementById('questionModalOverlay').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeQuestionModal(e) {
        if (e && e.target !== document.getElementById('questionModalOverlay')) return;
        document.getElementById('questionModalOverlay').classList.remove('open');
        document.body.style.overflow = '';
    }

    function submitQuestion(e) {
        e.preventDefault();
        var qName = document.getElementById('qName').value.trim();
        var qEmail = document.getElementById('qEmail').value.trim();
        var qPhone = document.getElementById('qPhone').value.trim();
        var qMessage = document.getElementById('qMessage').value.trim();
        var qContext = document.getElementById('qContext').value;
        if (!qName || !qEmail || !qMessage) return;

        var btn = document.getElementById('qSubmitBtn');
        btn.textContent = 'Sending...';
        btn.disabled = true;

        var formData = new FormData();
        formData.append('name', qName);
        formData.append('email', qEmail);
        if (qPhone) formData.append('phone', qPhone);
        formData.append('message', qMessage);
        formData.append('context', qContext);
        formData.append('intent', 'question');
        formData.append('_subject', 'QUESTION: ' + (currentRec ? currentRec.course : 'Courses page') + ' - ' + qName);

        fetch('https://formspree.io/f/PLACEHOLDER_BOOKING', {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        }).then(function(response) {
            if (response.ok) {
                fireEvent('question_submit_success');
                document.getElementById('questionForm').innerHTML = '<div style="text-align:center;padding:var(--space-4);">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:48px;height:48px;color:var(--green);margin-bottom:var(--space-3);"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' +
                    '<h4 style="color:var(--navy);margin-bottom:var(--space-2);">Question Sent!</h4>' +
                    '<p style="font-size:0.875rem;color:var(--gray-600);">We\'ll get back to you within 2 hours.</p>' +
                '</div>';
                setTimeout(closeQuestionModal, 3000);
            } else {
                btn.textContent = 'Try Again';
                btn.disabled = false;
            }
        }).catch(function() {
            btn.textContent = 'Try Again';
            btn.disabled = false;
        });
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeQuestionModal();
    });

    // ---- Membership Interest Toggle (D3) ----

    var membershipSelected = false;
    function toggleMembership() {
        var cb = document.getElementById('membershipCheck');
        var card = document.getElementById('membershipOffer');
        if (!cb || !card) return;
        if (document.activeElement !== cb) cb.checked = !cb.checked;
        membershipSelected = cb.checked;
        if (membershipSelected) {
            card.style.borderColor = 'var(--green)';
            card.style.background = 'linear-gradient(135deg,#ecfdf5 0%,#d1fae5 100%)';
            fireEvent('membership_interest', { price: 49 });
        } else {
            card.style.borderColor = '#7dd3fc';
            card.style.background = 'linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%)';
        }
    }

    // ---- Kit Upsell Toggle ----

    var kitUpsellSelected = false;
    function toggleKitUpsell() {
        var cb = document.getElementById('kitUpsellCheck');
        var card = document.getElementById('kitUpsellOffer');
        if (!cb || !card) return;
        // If triggered by card click (not checkbox directly), toggle the checkbox
        if (document.activeElement !== cb) cb.checked = !cb.checked;
        kitUpsellSelected = cb.checked;
        if (kitUpsellSelected) {
            card.classList.add('selected');
            fireEvent('upsell_accepted', { kit: upsellData ? upsellData.kit.name : 'Home & Family Kit' });
            fireEvent('order_bump_check', { kit: upsellData ? upsellData.kit.name : 'Home & Family Kit' });
        } else {
            card.classList.remove('selected');
        }
    }

    // ---- Submit Booking ----

    function submitBooking() {
        var name = document.getElementById('funnelName').value.trim();
        var email = document.getElementById('funnelEmail').value.trim();
        var phoneEl = document.getElementById('funnelPhone');
        var phone = phoneEl ? phoneEl.value.trim() : '';
        var companyEl = document.getElementById('funnelCompany');
        var company = companyEl ? companyEl.value.trim() : '';

        if (!name) { shakeField('funnelName'); return; }
        if (!email || email.indexOf('@') === -1) { shakeField('funnelEmail'); return; }
        // Phone is optional for individual, required for team (already validated in teamFormNext)

        // For team path, validate team size on step 2
        if (currentRec.isTeam) {
            var teamSizeEl = document.getElementById('funnelTeamSize');
            if (teamSizeEl && !teamSizeEl.value) {
                teamSizeEl.style.borderColor = 'var(--red)';
                teamSizeEl.focus();
                return;
            }
        }

        // For individual bookings, require a session selection (unless team)
        if (!currentRec.isTeam && funnelData.location !== 'onsite' && bookingMode === 'none') {
            var scheduleCards = document.querySelectorAll('.session-card');
            if (scheduleCards.length > 0) {
                scheduleCards[0].style.borderColor = 'var(--red)';
                scheduleCards[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        funnelData.name = name;
        funnelData.email = email;
        funnelData.phone = phone;
        funnelData.company = company;

        var btn = document.querySelector('.funnel-submit');
        if (btn) { btn.textContent = 'Reserving...'; btn.disabled = true; }

        var formData = new FormData();
        formData.append('name', funnelData.name);
        formData.append('email', funnelData.email);
        if (funnelData.phone) formData.append('phone', funnelData.phone);
        if (funnelData.company) formData.append('company', funnelData.company);
        formData.append('course', currentRec.course + ' (' + currentRec.code + ')');
        formData.append('price', currentRec.priceLabel || 'Quote requested');
        formData.append('type', funnelData.type);
        formData.append('location', funnelData.location);
        formData.append('urgency', funnelData.urgency);
        formData.append('booking_mode', bookingMode || 'direct');

        // Team-specific fields
        if (currentRec.isTeam) {
            var teamSizeVal = document.getElementById('funnelTeamSize');
            var datesVal = document.getElementById('funnelDates');
            var notesVal = document.getElementById('funnelNotes');
            if (teamSizeVal) formData.append('team_size', teamSizeVal.value);
            if (datesVal && datesVal.value) formData.append('preferred_dates', datesVal.value);
            if (notesVal && notesVal.value) formData.append('notes', notesVal.value);
        }

        // Kit upsell
        if (kitUpsellSelected && upsellData && upsellData.kit) {
            formData.append('upsell_kit', upsellData.kit.name + ' (' + upsellData.kit.priceLabel + ')');
        }

        // Membership interest
        if (membershipSelected) {
            formData.append('membership_interest', 'Annual Refresh Club ($49/yr)');
        }

        if (selectedSession) {
            formData.append('session_id', selectedSession.id);
            formData.append('session_date', selectedSession.dateISO);
            formData.append('session_label', selectedSession.label);
        } else if (bookingMode === 'request_next_available') {
            formData.append('session_id', 'request_next_available');
            formData.append('session_date', 'Next available');
        }

        formData.append('_subject', 'NEW BOOKING: ' + currentRec.course + ' - ' + funnelData.name + (selectedSession ? ' (' + selectedSession.label + ')' : ''));

        fetch('https://formspree.io/f/PLACEHOLDER_BOOKING', {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        }).then(function(response) {
            if (response.ok) {
                fireEvent('booking_submit_success', {
                    course: currentRec.code,
                    session_id: selectedSession ? selectedSession.id : 'request_next',
                    price: currentRec.price || 0
                });
                if (currentRec.isTeam) {
                    fireEvent('team_quote_submit', { course: currentRec.code, location: funnelData.location });
                }
                fireEvent('book_submit', { event_label: currentRec.course, value: currentRec.price || 0 });
                document.getElementById('confirmedContent').innerHTML = buildConfirmedHTML(currentRec);
                navigateTo('step-confirmed');
            } else {
                fireEvent('booking_submit_error', { error_type: 'response_not_ok' });
                sendBookingEmailFallback(currentRec);
                document.getElementById('confirmedContent').innerHTML = buildConfirmedHTML(currentRec);
                navigateTo('step-confirmed');
            }
        }).catch(function() {
            fireEvent('booking_submit_error', { error_type: 'network_error' });
            sendBookingEmailFallback(currentRec);
            document.getElementById('confirmedContent').innerHTML = buildConfirmedHTML(currentRec);
            navigateTo('step-confirmed');
        });
    }

    function shakeField(id) {
        var el = document.getElementById(id);
        el.style.borderColor = 'var(--red)';
        el.focus();
        el.classList.add('shake');
        setTimeout(function() { el.classList.remove('shake'); }, 500);
    }

    function buildConfirmedHTML(rec) {
        var firstName = funnelData.name.split(' ')[0];
        var slaHours = (sessionData && sessionData.meta && sessionData.meta.confirmationSLAHours) || 2;
        var phoneNumber = funnelData.location === 'widebay' ? '0488 488 467' : '0419 675 022';
        var phoneTel = funnelData.location === 'widebay' ? '0488488467' : '0419675022';

        // Session date display
        var sessionDateDisplay = '';
        if (selectedSession) {
            sessionDateDisplay = '<div class="funnel-result-meta-item">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
                '<div><strong>Date:</strong> ' + esc(selectedSession.label) + '</div>' +
            '</div>';
        } else if (bookingMode === 'request_next_available') {
            sessionDateDisplay = '<div class="funnel-result-meta-item">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' +
                '<div><strong>Date:</strong> We\'ll confirm the next available date</div>' +
            '</div>';
        }

        // Next steps — adjust wording based on session selection
        var step1Text = selectedSession
            ? '<strong>We\'ll confirm your spot within ' + slaHours + ' hours</strong> for ' + esc(selectedSession.label) + ' and send you all the details'
            : '<strong>We\'ll contact you within ' + slaHours + ' hours</strong> to confirm your course date and answer any questions';

        // Build upsell section based on what they booked
        var postBookUpsell = '';
        if (rec.code === 'HLTAID009') {
            postBookUpsell = '' +
                '<div class="funnel-confirmed-upsell">' +
                    '<h4>Want the Full Certification?</h4>' +
                    '<p>Upgrade to <strong>The Complete First Aider (HLTAID011)</strong> for just $60 more. You\'ll get CPR <em>plus</em> comprehensive workplace skills &mdash; and it\'s valid for 3 years instead of 1. Call us to upgrade your booking.</p>' +
                    '<a href="tel:' + phoneTel + '" class="btn btn-primary" style="margin-top:var(--space-3);">Call to Upgrade &mdash; ' + phoneNumber + '</a>' +
                '</div>';
        } else if (!rec.isTeam && !kitUpsellSelected) {
            postBookUpsell = '' +
                '<div class="funnel-confirmed-upsell">' +
                    '<h4>Complete Your Preparation</h4>' +
                    '<p>You\'re getting the training &mdash; make sure you have the gear too. Our workplace-compliant first aid kits are built for real emergencies, not just ticking a box.</p>' +
                    '<a href="shop.html" class="btn btn-primary" style="margin-top:var(--space-3);">Browse First Aid Kits</a>' +
                '</div>';
        } else if (!rec.isTeam && kitUpsellSelected) {
            postBookUpsell = '' +
                '<div class="funnel-confirmed-upsell" style="background:var(--green-light);border-color:var(--green);">' +
                    '<h4 style="color:var(--green);">First Aid Kit Added!</h4>' +
                    '<p>We\'ve added a <strong>' + (upsellData ? upsellData.kit.name : 'Home & Family Kit') + '</strong> to your order. We\'ll include delivery details in your confirmation email.</p>' +
                '</div>';
        }

        // Membership offer (post-booking upsell)
        if (!rec.isTeam) {
            postBookUpsell += '<div style="background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);border:1px solid #7dd3fc;border-radius:12px;padding:var(--space-4);margin-top:var(--space-3);text-align:center;">' +
                '<h4 style="font-family:var(--font-heading);font-size:1rem;color:var(--navy);margin-bottom:var(--space-1);">Never Miss a Renewal &mdash; Annual Refresh Club</h4>' +
                '<p style="font-size:0.875rem;color:var(--gray-600);">$49/yr gets you auto renewal reminders, refresher videos, and 15% off kits. We\'ll include enrollment details in your confirmation email.</p>' +
            '</div>';
        }

        return '' +
            '<div class="funnel-result-success">' +
                '<div class="funnel-result-check">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' +
                '</div>' +
                '<h2>You\'re Booked, ' + esc(firstName) + '!</h2>' +
                '<p>Your spot for <strong>' + esc(rec.course) + '</strong> has been secured.</p>' +
            '</div>' +

            '<div class="funnel-result-card">' +
                '<div class="funnel-result-confirmation" style="margin-bottom:var(--space-4);border:none;background:var(--green-light);">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;color:var(--green);flex-shrink:0;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' +
                    '<p><strong>Booking confirmation has been sent.</strong> Check your email at <strong>' + esc(funnelData.email) + '</strong> &mdash; forward it to your employer for approval if needed.</p>' +
                '</div>' +

                '<div class="funnel-result-meta">' +
                    '<div class="funnel-result-meta-item">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>' +
                        '<div><strong>Course:</strong> ' + esc(rec.course) + ' (' + esc(rec.code) + ')</div>' +
                    '</div>' +
                    sessionDateDisplay +
                    '<div class="funnel-result-meta-item">' +
                        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>' +
                        '<div><strong>Location:</strong> ' + esc(rec.locationDisplay) + '</div>' +
                    '</div>' +
                    (rec.price ? '<div class="funnel-result-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;color:var(--red);"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><div><strong>Price:</strong> ' + esc(rec.priceLabel) + ' (pay on the day)</div></div>' : '') +
                '</div>' +

                '<div class="funnel-result-next-steps" style="margin-top:var(--space-6);">' +
                    '<h4>What Happens Next?</h4>' +
                    '<div class="funnel-result-step"><span class="funnel-result-step-num">1</span><p>' + step1Text + '</p></div>' +
                    '<div class="funnel-result-step"><span class="funnel-result-step-num">2</span><p>You\'ll get a reminder before the day with everything you need to know</p></div>' +
                    '<div class="funnel-result-step"><span class="funnel-result-step-num">3</span><p>Show up, get trained, leave certified &mdash; pay on the day</p></div>' +
                '</div>' +
            '</div>' +

            postBookUpsell +

            // Renewal lock-in
            (rec.isTeam
                ? '<div style="background:linear-gradient(135deg,var(--navy) 0%,#243447 100%);border-radius:12px;padding:var(--space-6);margin-top:var(--space-6);color:white;text-align:center;">' +
                    '<h4 style="font-family:var(--font-heading);font-size:1.25rem;margin-bottom:var(--space-2);">Set Up an Annual Training Agreement</h4>' +
                    '<p style="font-size:0.9375rem;color:rgba(255,255,255,0.85);margin-bottom:var(--space-3);">Your team\'s CPR expires in 12 months. Instead of scrambling each year, let us handle it. We\'ll auto-schedule renewals, track every cert, and keep your business compliant year-round &mdash; one annual partnership, zero admin for you.</p>' +
                    '<a href="tel:' + phoneTel + '" class="btn btn-white" style="font-size:0.9375rem;">Call to Set Up Annual Agreement</a>' +
                  '</div>'
                : '<div style="background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px;padding:var(--space-5);margin-top:var(--space-6);text-align:center;">' +
                    '<h4 style="font-family:var(--font-heading);font-size:1.125rem;color:var(--navy);margin-bottom:var(--space-2);">Your Renewal is Already Sorted</h4>' +
                    '<p style="font-size:0.9375rem;color:var(--gray-600);">Your ' + (rec.code === 'HLTAID009' ? 'CPR cert expires in <strong>12 months</strong>' : 'CPR component expires in <strong>12 months</strong> (full cert valid 3 years)') + '. We\'ll send you a reminder 4 weeks before it\'s due so you never lapse. Same trainer, same easy process &mdash; just show up again.</p>' +
                  '</div>'
            ) +

            // Referral prompt
            '<div class="funnel-confirmed-referral" style="background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px;padding:var(--space-5);margin-top:var(--space-6);text-align:center;">' +
                '<h4 style="font-family:var(--font-heading);font-size:1.125rem;color:var(--navy);margin-bottom:var(--space-2);">Know Someone Who Needs Their First Aid?</h4>' +
                '<p style="font-size:0.9375rem;color:var(--gray-600);margin-bottom:var(--space-3);">Send them this page &mdash; they\'ll thank you when they\'re the one who knows what to do in an emergency.</p>' +
                '<button class="btn btn-outline" onclick="copyFunnelLink()" id="copyLinkBtn" style="font-size:0.875rem;">Copy Link to Share</button>' +
            '</div>' +

            // Fallback contact
            '<div style="background:var(--red-light);border:1px solid #fca5a5;border-radius:12px;padding:var(--space-4);margin-top:var(--space-4);text-align:center;">' +
                '<p style="font-size:0.875rem;color:var(--gray-700);"><strong>Didn\'t receive a confirmation email?</strong> No worries &mdash; your booking is logged. Call <a href="tel:' + phoneTel + '" style="color:var(--red);font-weight:600;">' + phoneNumber + '</a> or email <a href="mailto:admin@coralseatraining.com.au" style="color:var(--red);font-weight:600;">admin@coralseatraining.com.au</a> to verify.</p>' +
            '</div>' +

            '<div class="funnel-result-cta-row">' +
                '<a href="tel:' + phoneTel + '" class="btn btn-primary btn-lg">' +
                    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>' +
                    'Questions? Call Us' +
                '</a>' +
                '<a href="index.html" class="btn btn-outline btn-lg">Back to Homepage</a>' +
            '</div>';
    }

    function copyFunnelLink() {
        var url = window.location.origin + '/courses.html';
        if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(function() {
                var btn = document.getElementById('copyLinkBtn');
                btn.textContent = 'Link Copied!';
                setTimeout(function() { btn.textContent = 'Copy Link to Share'; }, 2000);
            });
        }
    }

    function sendBookingEmailFallback(rec) {
        var situationLabel = funnelData.type === 'individual'
            ? (funnelData.industry === 'childcare' ? 'Individual - Childcare/Education' : 'Individual - General/Workplace')
            : (funnelData.delivery === 'onsite' ? 'Team - On-site Training' : 'Team - Venue Booking');

        var partnerLabel = '';
        if (funnelData.partner === 'yes') {
            partnerLabel = 'Existing Partner';
        } else if (funnelData.partner === 'interested') {
            partnerLabel = 'Interested in Partnership';
        }

        var subject = encodeURIComponent('NEW BOOKING: ' + rec.course + ' - ' + funnelData.name);
        var body = encodeURIComponent(
            'NEW BOOKING FROM WEBSITE\n' +
            '================================\n\n' +
            'Name: ' + funnelData.name + '\n' +
            'Email: ' + funnelData.email + '\n' +
            'Phone: ' + funnelData.phone + '\n' +
            (funnelData.company ? 'Company: ' + funnelData.company + '\n' : '') +
            '\n' +
            'BOOKING DETAILS\n' +
            '--------------------------------\n' +
            'Course: ' + rec.course + ' (' + rec.code + ')\n' +
            (rec.price ? 'Price: ' + rec.priceLabel + '\n' : '') +
            'Type: ' + situationLabel + '\n' +
            (partnerLabel ? 'Partner Status: ' + partnerLabel + '\n' : '') +
            'Preferred Location: ' + funnelData.location + '\n' +
            'Urgency: ' + funnelData.urgency + '\n' +
            (selectedSession ? 'Selected Session: ' + selectedSession.label + ' (' + selectedSession.id + ')\n' : (bookingMode === 'request_next_available' ? 'Session: Requested next available\n' : '')) +
            '\n' +
            'ACTION REQUIRED: Please confirm course date and send booking details to the student.'
        );

        var mailtoLink = 'mailto:admin@coralseatraining.com.au?subject=' + subject + '&body=' + body;
        var iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = mailtoLink;
        document.body.appendChild(iframe);
        setTimeout(function() { document.body.removeChild(iframe); }, 2000);

        // Analytics event only — no PII logged to console
        if (typeof gtag !== 'undefined') {
            gtag('event', 'purchase', {
                'event_category': 'Booking',
                'event_label': rec.course,
                'value': rec.price || 0
            });
        }
    }
    </script>
</body>
</html>
