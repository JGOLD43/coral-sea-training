<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Book your First Aid course in under 30 seconds. See available dates, pick a session, and reserve your spot. CPR, First Aid, Childcare & Advanced courses. RTO #32221.">
    <meta property="og:title" content="Book Your Course | Coral Sea Training">
    <meta property="og:description" content="See available dates and book your First Aid course in under 30 seconds. RTO #32221.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://jgold43.github.io/coral-sea-training/courses.html">
    <meta property="og:image" content="https://images.pexels.com/photos/11655091/pexels-photo-11655091.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2">
    <link rel="canonical" href="https://jgold43.github.io/coral-sea-training/courses.html">
    <title>Book Your Course | Coral Sea Training | RTO #32221</title>

    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='46' fill='%231B8A3D' stroke='%23D90A0A' stroke-width='6'/%3E%3Ctext x='50' y='68' text-anchor='middle' fill='white' font-size='50' font-weight='bold'%3E+%3C/text%3E%3C/svg%3E">
    <style>
        /* ========== Booking Funnel Styles (bf-*) ========== */

        /* Party size toggle */
        .bf-party-toggle {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: var(--space-6);
            background: var(--gray-100);
            border-radius: 100px;
            padding: 4px;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }
        .bf-party-btn {
            flex: 1;
            padding: var(--space-2) var(--space-4);
            border: none;
            border-radius: 100px;
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: var(--gray-600);
            transition: all 0.2s var(--ease-out);
        }
        .bf-party-btn.active {
            background: var(--white);
            color: var(--navy);
            box-shadow: var(--shadow-sm);
        }

        /* Group size stepper */
        .bf-group-panel {
            text-align: center;
            margin-bottom: var(--space-5);
            animation: fadeInUp 0.3s var(--ease-out);
        }
        .bf-group-panel label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--navy);
        }
        .bf-stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-4);
            margin: var(--space-3) 0;
        }
        .bf-stepper button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: white;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--navy);
            transition: all 0.15s;
        }
        .bf-stepper button:hover { border-color: var(--red); color: var(--red); }
        .bf-stepper span {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--navy);
            min-width: 40px;
            text-align: center;
        }

        /* Location cards */
        .bf-location-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-4);
            max-width: 680px;
            margin: 0 auto;
        }
        @media (min-width: 640px) {
            .bf-location-cards { grid-template-columns: 1fr 1fr; }
        }
        .bf-location-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: var(--space-6);
            text-align: center;
            transition: all 0.2s var(--ease-out);
        }
        .bf-location-card:hover {
            border-color: var(--green);
            box-shadow: 0 4px 16px rgba(27, 138, 61, 0.12);
        }
        .bf-location-header h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--navy);
            margin-bottom: var(--space-1);
        }
        .bf-address {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin: 0;
        }
        .bf-next-session {
            margin: var(--space-4) 0;
            padding: var(--space-3);
            background: var(--gray-50);
            border-radius: 10px;
        }
        .bf-next-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: block;
        }
        .bf-next-date {
            font-size: 1rem;
            font-weight: 700;
            color: var(--navy);
            display: block;
            margin: 4px 0;
        }
        .bf-next-time {
            font-size: 0.8125rem;
            color: var(--gray-600);
            display: block;
        }
        .bf-seats {
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }
        .bf-seats.low { color: var(--red); }
        .bf-seats.ok { color: var(--green); }
        .bf-book-earliest {
            width: 100%;
            margin-bottom: var(--space-2);
        }
        .bf-see-all {
            background: none;
            border: none;
            color: var(--green);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            padding: var(--space-2);
            font-family: var(--font-body);
            transition: color 0.15s;
        }
        .bf-see-all:hover { color: var(--red); text-decoration: underline; }
        .bf-no-sessions {
            padding: var(--space-4);
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        /* Course cards (Step B) */
        .bf-course-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-4);
            max-width: 820px;
            margin: 0 auto;
        }
        @media (min-width: 640px) {
            .bf-course-cards { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 900px) {
            .bf-course-cards { grid-template-columns: repeat(4, 1fr); }
        }
        .bf-course-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: var(--space-5) var(--space-4);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s var(--ease-out);
            position: relative;
        }
        .bf-course-card:hover {
            border-color: var(--green);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(27, 138, 61, 0.12);
        }
        .bf-course-card.selected {
            border-color: var(--green);
            background: #f0faf3;
        }
        .bf-course-card.bf-recommended { border-color: var(--green); }
        .bf-rec-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--green);
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            padding: 2px 12px;
            border-radius: 20px;
            text-transform: uppercase;
            white-space: nowrap;
            letter-spacing: 0.03em;
        }
        .bf-course-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-3);
            font-size: 1.25rem;
        }
        .bf-course-card h3 {
            font-family: var(--font-body);
            font-size: 0.9375rem;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 4px;
        }
        .bf-course-card p {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-bottom: var(--space-2);
        }
        .bf-course-price {
            font-size: 1.375rem;
            font-weight: 800;
            color: var(--navy);
            display: block;
            margin: var(--space-2) 0;
        }
        .bf-course-meta {
            font-size: 0.6875rem;
            color: var(--gray-400);
            display: block;
        }

        /* Help link */
        .bf-help-link {
            background: none;
            border: none;
            color: var(--gray-500);
            font-size: 0.875rem;
            cursor: pointer;
            text-decoration: underline;
            font-family: var(--font-body);
            padding: var(--space-2);
        }
        .bf-help-link:hover { color: var(--green); }

        /* Help flow */
        .bf-help-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }
        .bf-help-btn {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: var(--space-4);
            cursor: pointer;
            font-family: var(--font-body);
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--navy);
            text-align: center;
            transition: all 0.15s;
        }
        .bf-help-btn:hover { border-color: var(--green); background: #f0faf3; }
        .bf-help-btn small {
            display: block;
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--gray-500);
            margin-top: 4px;
        }
        .bf-help-result {
            text-align: center;
            padding: var(--space-4);
            animation: fadeInUp 0.3s var(--ease-out);
        }
        .bf-help-result h4 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--navy);
            margin-bottom: var(--space-2);
        }
        .bf-help-result p {
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: var(--space-4);
        }

        /* Confirm layout */
        .bf-confirm-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-6);
            max-width: 780px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            .bf-confirm-layout { grid-template-columns: 5fr 7fr; }
        }
        .bf-summary-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: var(--space-6);
        }
        .bf-summary-card h3 {
            font-family: var(--font-display);
            font-size: 1.125rem;
            color: var(--navy);
            margin-bottom: 2px;
        }
        .bf-summary-code {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .bf-summary-details {
            margin: var(--space-4) 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .bf-summary-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
            font-size: 0.875rem;
            color: var(--gray-700);
        }
        .bf-summary-row svg {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            color: var(--green);
            margin-top: 1px;
        }
        .bf-summary-price {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-200);
        }
        .bf-price-amount {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--green);
        }
        .bf-price-note {
            font-size: 0.8125rem;
            color: var(--gray-500);
            display: block;
            margin-top: 2px;
        }
        .bf-change-link {
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 0.8125rem;
            cursor: pointer;
            text-decoration: underline;
            font-family: var(--font-body);
            margin-top: var(--space-3);
            display: inline-block;
        }
        .bf-change-link:hover { color: var(--green); }

        .bf-form-card {
            background: var(--white);
            border-radius: 20px;
            padding: var(--space-6);
            box-shadow: var(--shadow-lg);
        }
        .bf-form-card h3 {
            font-family: var(--font-display);
            font-size: 1.125rem;
            color: var(--navy);
            margin-bottom: 4px;
        }
        .bf-form-sub {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-bottom: var(--space-5);
        }
        .bf-submit {
            width: 100%;
            margin-top: var(--space-3);
        }
        .bf-pay-note {
            text-align: center;
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-top: var(--space-3);
            margin-bottom: 0;
        }
        .bf-trust-stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: var(--space-5);
            padding-top: var(--space-4);
            border-top: 1px solid var(--gray-100);
        }
        .bf-trust-item {
            font-size: 0.75rem;
            color: var(--gray-500);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .bf-trust-item svg { width: 14px; height: 14px; color: var(--green); flex-shrink: 0; }

        /* Group summary row on confirm */
        .bf-group-confirm {
            background: #f0faf3;
            border: 1px solid var(--green);
            border-radius: 10px;
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--navy);
        }

        /* Swap notice */
        .bf-swap-notice {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: var(--space-3) var(--space-4);
            margin: var(--space-4) 0;
            font-size: 0.8125rem;
            color: #92400e;
            line-height: 1.5;
        }
        .bf-swap-notice strong { color: #78350f; }

        /* Modals */
        .bf-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .bf-modal-overlay.open { opacity: 1; visibility: visible; }
        .bf-modal {
            background: white;
            border-radius: 16px;
            max-width: 520px;
            width: 100%;
            padding: var(--space-6);
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.2s var(--ease-out);
        }
        .bf-modal h3 {
            font-family: var(--font-display);
            font-size: 1.125rem;
            color: var(--navy);
            margin-bottom: var(--space-4);
            padding-right: var(--space-8);
        }
        .bf-modal-close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            background: var(--gray-100);
            border: none;
            cursor: pointer;
            color: var(--gray-500);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background 0.15s;
        }
        .bf-modal-close:hover { background: var(--gray-200); }

        /* Session items in modal */
        .bf-session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.15s;
        }
        .bf-session-item:hover { border-color: var(--green); }
        .bf-session-item.disabled {
            opacity: 0.45;
            pointer-events: none;
        }
        .bf-session-date {
            font-weight: 700;
            color: var(--navy);
            font-size: 0.9375rem;
        }
        .bf-session-time {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }
        .bf-session-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }
        .bf-session-badge {
            font-size: 0.625rem;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--gray-100);
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* Course filter tabs in session modal */
        .bf-course-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: var(--space-4);
        }
        .bf-filter-btn {
            padding: 4px 12px;
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            background: white;
            font-family: var(--font-body);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s;
        }
        .bf-filter-btn.active {
            background: var(--green);
            color: white;
            border-color: var(--green);
        }
        .bf-filter-btn:hover:not(.active) { border-color: var(--green); color: var(--green); }

        /* Responsive tweaks */
        @media (max-width: 640px) {
            .bf-form-card { padding: var(--space-5); }
            .bf-summary-card { padding: var(--space-4); }
            .bf-stepper button { width: 44px; height: 44px; }
            .bf-help-options { grid-template-columns: 1fr; }
        }

        /* Fade animation (if not in style.css) */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bf-fade-in { animation: fadeInUp 0.3s var(--ease-out); }
    </style>
</head>
<body>

    <!-- Minimal funnel header -->
    <header class="header" id="header">
        <div class="container">
            <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:80px;">
                <div style="justify-self:start;">
                    <button id="funnelHeaderBack" onclick="goBack()" style="display:none;align-items:center;gap:6px;background:none;border:none;cursor:pointer;font-family:var(--font-body);font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.85);padding:var(--space-2) var(--space-3);border-radius:8px;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><polyline points="15 18 9 12 15 6"/></svg>
                        Back
                    </button>
                </div>
                <div class="logo" style="pointer-events:none;">
                    <div class="logo-mark">+</div>
                    <div class="logo-text">
                        <span class="logo-name">Coral Sea Training</span>
                        <span class="logo-tagline">RTO #32221</span>
                    </div>
                </div>
                <div style="justify-self:end;">
                    <a href="contact.html?show=form" style="display:flex;align-items:center;gap:6px;text-decoration:none;font-family:var(--font-body);font-size:0.875rem;font-weight:600;color:rgba(255,255,255,0.85);padding:var(--space-2) var(--space-3);border-radius:8px;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        FAQ
                    </a>
                </div>
            </div>
        </div>
    </header>


    <!-- Funnel Section -->
    <section class="funnel-section">
        <div class="container">
            <div class="funnel-wrapper">

                <!-- Progress Bar -->
                <div class="funnel-progress-wrapper">
                    <div class="funnel-progress-bar">
                        <div class="funnel-progress-fill" id="progressFill" style="width: 33%"></div>
                    </div>
                    <div style="display:flex;justify-content:space-between;margin-top:6px;">
                        <span class="funnel-step-label" id="stepLabel">Step 1 of 3 &mdash; Location &amp; Date</span>
                        <span id="stepTimeHint" style="font-size:0.75rem;color:var(--gray-500);font-weight:500;">Takes 30 seconds</span>
                    </div>
                </div>

                <!-- ===== STEP A: Location + Dates ===== -->
                <div class="funnel-step active" id="step-location">
                    <div class="funnel-step-header">
                        <h1 class="funnel-title">Pick a date near you</h1>
                        <p class="funnel-subtitle">Book in under 30 seconds. Pay on the day.</p>
                    </div>

                    <!-- Party size toggle -->
                    <div class="bf-party-toggle">
                        <button class="bf-party-btn active" data-size="1" onclick="setPartySize(1, this)">Just me</button>
                        <button class="bf-party-btn" data-size="2" onclick="setPartySize(2, this)">2+ people</button>
                    </div>

                    <!-- Group size panel (hidden by default) -->
                    <div class="bf-group-panel" id="groupSizePanel" style="display:none;">
                        <label>How many people?</label>
                        <div class="bf-stepper">
                            <button type="button" onclick="adjustGroupSize(-1)">&minus;</button>
                            <span id="groupSizeDisplay">2</span>
                            <button type="button" onclick="adjustGroupSize(1)">+</button>
                        </div>
                        <div id="groupCompanyField" style="display:none;max-width:300px;margin:0 auto;">
                            <input type="text" id="companyName" class="form-input" placeholder="Company name (optional)" style="text-align:center;">
                        </div>
                    </div>

                    <!-- Location cards (populated by JS) -->
                    <div class="bf-location-cards" id="locationCards">
                        <div style="text-align:center;padding:var(--space-8);color:var(--gray-400);">Loading sessions...</div>
                    </div>

                    <!-- Social proof -->
                    <div class="funnel-social-proof" style="margin-top:var(--space-6);">
                        <span style="font-weight:700;color:var(--navy);">4.4&#9733; on Google</span>
                        <span style="color:var(--gray-400);">&bull;</span>
                        <span>RTO #32221</span>
                        <span style="color:var(--gray-400);">&bull;</span>
                        <span><strong>10,000+</strong> trained</span>
                    </div>
                </div>


                <!-- ===== STEP B: Course Requirement ===== -->
                <div class="funnel-step" id="step-course">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">What do you need?</h2>
                        <p class="funnel-subtitle">Not sure? Choose the recommended option to stay compliant for most workplaces.</p>
                    </div>

                    <div class="bf-course-cards" id="courseCards">
                        <!-- Card 1: Recommended -->
                        <div class="bf-course-card bf-recommended" data-course="hltaid011" onclick="selectCourse('hltaid011', this)">
                            <span class="bf-rec-badge">Recommended</span>
                            <div class="bf-course-icon" style="background:#f0faf3;color:var(--green);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            </div>
                            <h3>Keep me compliant</h3>
                            <p>Full First Aid + CPR</p>
                            <span class="bf-course-price">$159</span>
                            <span class="bf-course-meta">HLTAID011 &bull; 7 hours &bull; Valid 3 years</span>
                        </div>

                        <!-- Card 2: CPR only -->
                        <div class="bf-course-card" data-course="hltaid009" onclick="selectCourse('hltaid009', this)">
                            <div class="bf-course-icon" style="background:#fef2f2;color:var(--red);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                            </div>
                            <h3>CPR renewal</h3>
                            <p>Quick refresh</p>
                            <span class="bf-course-price">$99</span>
                            <span class="bf-course-meta">HLTAID009 &bull; 3 hours &bull; Valid 12 months</span>
                        </div>

                        <!-- Card 3: Childcare -->
                        <div class="bf-course-card" data-course="hltaid012" onclick="selectCourse('hltaid012', this)">
                            <div class="bf-course-icon" style="background:#eff6ff;color:#2563eb;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                            <h3>Childcare / Education</h3>
                            <p>ACECQA approved</p>
                            <span class="bf-course-price">$199</span>
                            <span class="bf-course-meta">HLTAID012 &bull; 8 hours &bull; Valid 3 years</span>
                        </div>

                        <!-- Card 4: Advanced -->
                        <div class="bf-course-card" data-course="hltaid015" onclick="selectCourse('hltaid015', this)">
                            <div class="bf-course-icon" style="background:#faf5ff;color:#7c3aed;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            </div>
                            <h3>Advanced Resuscitation</h3>
                            <p>Healthcare professionals</p>
                            <span class="bf-course-price">$199</span>
                            <span class="bf-course-meta">HLTAID015 &bull; 6 hours &bull; Valid 12 months</span>
                        </div>
                    </div>

                    <!-- Help me choose -->
                    <div style="text-align:center;margin-top:var(--space-5);">
                        <button class="bf-help-link" onclick="openHelpFlow()">Not sure? Help me choose (2 questions)</button>
                    </div>
                </div>


                <!-- ===== STEP C: Confirm + Booking Form ===== -->
                <div class="funnel-step" id="step-confirm">
                    <div class="funnel-step-header">
                        <h2 class="funnel-title">Confirm your booking</h2>
                    </div>

                    <div class="bf-confirm-layout">
                        <!-- Left: Summary -->
                        <div class="bf-summary-card">
                            <h3 id="confirmCourseName">The Complete First Aider</h3>
                            <span class="bf-summary-code" id="confirmCourseCode">HLTAID011</span>

                            <div class="bf-summary-details">
                                <div class="bf-summary-row">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    <span id="confirmDate">Sun 22 Feb &bull; 08:30 - 16:30</span>
                                </div>
                                <div class="bf-summary-row">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <span id="confirmLocation">Townsville &mdash; 40 Charles St, Aitkenvale</span>
                                </div>
                                <div class="bf-summary-row">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    <span id="confirmDuration">Approx. 7 hours (1 day)</span>
                                </div>
                            </div>

                            <div id="swapNotice" class="bf-swap-notice" style="display:none;"></div>

                            <div class="bf-summary-price">
                                <span class="bf-price-amount" id="confirmPrice">$159</span>
                                <span class="bf-price-note" id="confirmPriceNote">per person &bull; pay on the day</span>
                            </div>

                            <button class="bf-change-link" onclick="goBack()">Change selections</button>
                        </div>

                        <!-- Right: Booking form -->
                        <div class="bf-form-card">
                            <h3>Your details</h3>
                            <p class="bf-form-sub">We'll confirm your spot within 2 hours.</p>

                            <!-- Group summary (hidden for solo) -->
                            <div class="bf-group-confirm" id="groupConfirmRow" style="display:none;">
                                <span id="groupConfirmText">Booking for 2 people</span>
                                <span id="groupConfirmTotal" style="color:var(--green);">Total: $318</span>
                            </div>

                            <form id="bookingForm" onsubmit="return false;">
                                <div class="funnel-form-group">
                                    <input type="text" id="bfFirstName" class="form-input" placeholder="First name *" required autocomplete="given-name">
                                </div>
                                <div class="funnel-form-group">
                                    <input type="text" id="bfLastName" class="form-input" placeholder="Last name *" required autocomplete="family-name">
                                </div>
                                <div class="funnel-form-group">
                                    <input type="email" id="bfEmail" class="form-input" placeholder="Email *" required autocomplete="email">
                                </div>
                                <div class="funnel-form-group">
                                    <input type="tel" id="bfPhone" class="form-input" placeholder="Mobile *" required autocomplete="tel">
                                </div>
                                <div class="funnel-form-group" id="employerField">
                                    <input type="text" id="bfEmployer" class="form-input" placeholder="Employer (optional)" autocomplete="organization">
                                </div>
                                <div class="funnel-form-group" id="companyFieldConfirm" style="display:none;">
                                    <input type="text" id="bfCompany" class="form-input" placeholder="Company / organisation *" autocomplete="organization">
                                </div>

                                <button type="button" class="btn btn-primary btn-lg bf-submit" id="submitBtn" onclick="submitBooking()">
                                    Reserve My Spot
                                </button>

                                <p class="bf-pay-note">No payment now &mdash; pay on the day</p>
                            </form>

                            <!-- Trust stack -->
                            <div class="bf-trust-stack">
                                <div class="bf-trust-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Fast confirmation (within 2 hours)
                                </div>
                                <div class="bf-trust-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Pay on the day
                                </div>
                                <div class="bf-trust-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    100% Skills Mastery Guarantee
                                </div>
                                <div class="bf-trust-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    Forward-to-employer certificate
                                </div>
                                <div class="bf-trust-item" style="margin-top:4px;font-size:0.6875rem;color:var(--gray-400);">
                                    RTO #32221 &bull; 4.4&#9733; on Google &bull; Nationally Accredited
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /funnel-wrapper -->
        </div>
    </section>


    <!-- ===== Session List Modal ===== -->
    <div class="bf-modal-overlay" id="sessionModal" onclick="closeModal('sessionModal', event)">
        <div class="bf-modal" onclick="event.stopPropagation()">
            <button class="bf-modal-close" onclick="closeModal('sessionModal')">&times;</button>
            <h3 id="sessionModalTitle">Available Sessions</h3>
            <div class="bf-course-filter" id="sessionCourseFilter"></div>
            <div id="sessionModalList"></div>
        </div>
    </div>


    <!-- ===== Help Me Choose Modal ===== -->
    <div class="bf-modal-overlay" id="helpModal" onclick="closeModal('helpModal', event)">
        <div class="bf-modal" onclick="event.stopPropagation()">
            <button class="bf-modal-close" onclick="closeModal('helpModal')">&times;</button>

            <!-- Q1 -->
            <div id="helpQ1">
                <h3>Do you work in childcare or education?</h3>
                <p style="font-size:0.875rem;color:var(--gray-500);">This determines if you need ACECQA-approved training.</p>
                <div class="bf-help-options">
                    <button class="bf-help-btn" onclick="helpAnswer(1, 'childcare')">
                        Yes
                        <small>Childcare / Education</small>
                    </button>
                    <button class="bf-help-btn" onclick="helpAnswer(1, 'other')">
                        No
                        <small>Another industry</small>
                    </button>
                </div>
            </div>

            <!-- Q2 (hidden initially) -->
            <div id="helpQ2" style="display:none;">
                <h3>What does your employer require?</h3>
                <p style="font-size:0.875rem;color:var(--gray-500);">If you're not sure, Full First Aid is the safest choice.</p>
                <div class="bf-help-options">
                    <button class="bf-help-btn" onclick="helpAnswer(2, 'full')">
                        Full First Aid
                        <small>Most workplaces require this</small>
                    </button>
                    <button class="bf-help-btn" onclick="helpAnswer(2, 'cpr')">
                        Just CPR
                        <small>Annual renewal only</small>
                    </button>
                </div>
            </div>

            <!-- Result (hidden initially) -->
            <div id="helpResult" style="display:none;" class="bf-help-result">
                <h4 id="helpRecTitle">We recommend: Keep me compliant</h4>
                <p id="helpRecReason">Most workplaces accept Full First Aid. It's the safest choice if you're unsure.</p>
                <button class="btn btn-primary" id="helpRecBtn" onclick="applyHelpRecommendation()">Continue with this</button>
            </div>
        </div>
    </div>


    <!-- Minimal footer -->
    <footer style="padding:var(--space-6) 0;text-align:center;font-size:0.75rem;color:var(--gray-400);border-top:1px solid var(--gray-200);">
        <div class="container">
            <p style="margin:0;">Coral Sea Training &bull; RTO #32221 &bull; Nationally Accredited &bull; &copy; 2026</p>
        </div>
    </footer>


    <!-- Structured data -->
    <script type="application/ld+json">
    [
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "CPR Course (HLTAID009)",
            "description": "Learn CPR and AED defibrillator use. Annual renewal. Approx. 3 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "99", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        },
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Provide First Aid (HLTAID011)",
            "description": "Complete workplace First Aid certification including CPR. Valid 3 years. Approx. 7 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "159", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        },
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Childcare First Aid (HLTAID012)",
            "description": "ACECQA-approved First Aid for childcare and education workers. Includes CPR, anaphylaxis, asthma. Approx. 8 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "199", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        },
        {
            "@context": "https://schema.org",
            "@type": "Course",
            "name": "Advanced Resuscitation (HLTAID015)",
            "description": "Advanced resuscitation techniques for healthcare and emergency workers. Approx. 6 hours.",
            "provider": { "@type": "Organization", "name": "Coral Sea Training", "url": "https://jgold43.github.io/coral-sea-training/" },
            "offers": { "@type": "Offer", "price": "199", "priceCurrency": "AUD", "availability": "https://schema.org/InStock" }
        }
    ]
    </script>

    <script src="js/course-data.js"></script>
    <script>

    // =====================================================
    // Booking Funnel â€” 3-Step Streamlined Flow
    // =====================================================

    // --- Utility: HTML escape ---
    function esc(str) {
        var d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }

    // --- Analytics ---
    function fireEvent(name, params) {
        if (typeof gtag !== 'undefined') {
            gtag('event', name, params || {});
        }
    }

    // --- Booking State ---
    var state = {
        location: null,
        locationLabel: null,
        locationAddress: null,
        sessionId: null,
        sessionDate: null,
        sessionLabel: null,
        sessionStart: null,
        sessionEnd: null,
        courseId: null,
        partySize: 1,
        companyName: '',
        swapped: false,
        originalSessionId: null,
        helpUsed: false,
        helpRecommendation: null
    };

    // --- Session Data ---
    var sessionData = null;
    var sessionIndex = {};   // sessionIndex[courseId][locationId] = [sessions...]
    var locationMeta = {};   // locationMeta[locationId] = { label, address }
    var courseMeta = {};     // courseMeta[courseId] = { code, offerName, price, duration, validity, includes }

    // --- Step Navigation ---
    var stepHistory = [];
    var currentStep = 'step-location';
    var stepConfig = {
        'step-location': { num: 1, label: 'Location & Date', progress: 33 },
        'step-course':   { num: 2, label: 'Your Requirement', progress: 66 },
        'step-confirm':  { num: 3, label: 'Confirm & Book',   progress: 100 }
    };

    function navigateTo(stepId) {
        document.querySelectorAll('.funnel-step').forEach(function(s) {
            s.classList.remove('active');
        });
        var el = document.getElementById(stepId);
        el.classList.add('active');
        el.classList.add('bf-fade-in');
        stepHistory.push(currentStep);
        currentStep = stepId;
        updateProgressUI();
        window.scrollTo({ top: 0, behavior: 'instant' });
        fireEvent('bf_step_view', { step_id: stepId });
    }

    function goBack() {
        if (stepHistory.length === 0) {
            window.location.href = 'index.html';
            return;
        }
        var prev = stepHistory.pop();
        document.querySelectorAll('.funnel-step').forEach(function(s) {
            s.classList.remove('active');
        });
        document.getElementById(prev).classList.add('active');
        currentStep = prev;
        updateProgressUI();
        window.scrollTo({ top: 0, behavior: 'instant' });
    }

    function updateProgressUI() {
        var cfg = stepConfig[currentStep];
        if (!cfg) return;
        document.getElementById('progressFill').style.width = cfg.progress + '%';
        document.getElementById('stepLabel').innerHTML = 'Step ' + cfg.num + ' of 3 &mdash; ' + cfg.label;

        var backBtn = document.getElementById('funnelHeaderBack');
        backBtn.style.display = (stepHistory.length > 0 || currentStep !== 'step-location') ? 'flex' : 'none';

        var hint = document.getElementById('stepTimeHint');
        if (cfg.num === 1) hint.textContent = 'Takes 30 seconds';
        else if (cfg.num === 2) hint.textContent = 'Almost done';
        else hint.textContent = '';
    }


    // =====================================================
    // DATA LOADING
    // =====================================================

    function loadSessionData() {
        return fetch('data/sessions.json')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sessionData = data;
                buildIndices(data);
            })
            .catch(function(err) {
                console.error('Failed to load sessions:', err);
            });
    }

    function buildIndices(data) {
        var today = new Date().toISOString().slice(0, 10);
        data.courses.forEach(function(course) {
            courseMeta[course.id] = {
                code: course.code,
                offerName: course.offerName,
                price: course.price,
                duration: course.duration,
                validity: course.validity,
                includes: course.includes
            };
            sessionIndex[course.id] = {};
            var locs = course.locations;
            Object.keys(locs).forEach(function(locId) {
                var loc = locs[locId];
                locationMeta[locId] = { label: loc.label, address: loc.address };
                sessionIndex[course.id][locId] = loc.sessions.filter(function(s) {
                    return s.dateISO >= today && s.seatsLeft > 0;
                }).sort(function(a, b) {
                    return a.dateISO < b.dateISO ? -1 : a.dateISO > b.dateISO ? 1 : 0;
                });
            });
        });
    }

    // Get earliest session across ALL course types at a location
    function getEarliestSession(locationId) {
        var earliest = null;
        var earliestCourse = null;
        Object.keys(sessionIndex).forEach(function(courseId) {
            var sessions = sessionIndex[courseId][locationId];
            if (sessions && sessions.length > 0) {
                var s = sessions[0];
                if (!earliest || s.dateISO < earliest.dateISO) {
                    earliest = s;
                    earliestCourse = courseId;
                }
            }
        });
        return earliest ? { session: earliest, courseId: earliestCourse } : null;
    }

    // Get all sessions at a location, across all courses, for a given filter
    function getSessionsForLocation(locationId, filterCourseId) {
        var results = [];
        var courseIds = filterCourseId ? [filterCourseId] : Object.keys(sessionIndex);
        courseIds.forEach(function(courseId) {
            var sessions = sessionIndex[courseId] && sessionIndex[courseId][locationId];
            if (sessions) {
                sessions.forEach(function(s) {
                    results.push({
                        session: s,
                        courseId: courseId,
                        courseCode: courseMeta[courseId] ? courseMeta[courseId].code : courseId
                    });
                });
            }
        });
        // Sort by date
        results.sort(function(a, b) {
            return a.session.dateISO < b.session.dateISO ? -1 : a.session.dateISO > b.session.dateISO ? 1 : 0;
        });
        return results;
    }


    // =====================================================
    // STEP A: Location + Dates
    // =====================================================

    function renderLocationCards() {
        var html = '';
        var locIds = Object.keys(locationMeta);
        locIds.forEach(function(locId) {
            var loc = locationMeta[locId];
            var earliest = getEarliestSession(locId);
            var nextHtml = '';
            if (earliest) {
                var s = earliest.session;
                var seatsClass = s.seatsLeft <= 4 ? 'low' : 'ok';
                nextHtml = '<div class="bf-next-session">' +
                    '<span class="bf-next-label">Next available:</span>' +
                    '<span class="bf-next-date">' + esc(s.label) + '</span>' +
                    '<span class="bf-next-time">' + esc(s.start) + ' &ndash; ' + esc(s.end) + '</span>' +
                    '<span class="bf-seats ' + seatsClass + '">' + s.seatsLeft + ' seats left</span>' +
                '</div>';
            } else {
                nextHtml = '<div class="bf-no-sessions">No upcoming sessions</div>';
            }

            var canBook = earliest && earliest.session.seatsLeft >= state.partySize;
            var bookDisabled = !canBook ? ' disabled style="opacity:0.5;pointer-events:none;"' : '';

            html += '<div class="bf-location-card">' +
                '<div class="bf-location-header">' +
                    '<h3>' + esc(loc.label) + '</h3>' +
                    '<p class="bf-address">' + esc(loc.address) + '</p>' +
                '</div>' +
                nextHtml +
                '<button class="btn btn-primary bf-book-earliest"' + bookDisabled +
                    ' onclick="selectEarliestSession(\'' + locId + '\')">' +
                    'Book earliest' +
                '</button>' +
                '<button class="bf-see-all" onclick="openSessionModal(\'' + locId + '\')">See all dates</button>' +
            '</div>';
        });
        document.getElementById('locationCards').innerHTML = html || '<p style="text-align:center;color:var(--gray-500);">No locations available.</p>';
    }


    // --- Party Size ---
    function setPartySize(size, btn) {
        document.querySelectorAll('.bf-party-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');

        if (size === 1) {
            state.partySize = 1;
            document.getElementById('groupSizePanel').style.display = 'none';
        } else {
            state.partySize = 2;
            document.getElementById('groupSizePanel').style.display = 'block';
            document.getElementById('groupSizeDisplay').textContent = '2';
            updateGroupCompanyField();
        }
        fireEvent('bf_party_toggle', { party_size: size === 1 ? 1 : '2+' });
        renderLocationCards();
    }

    function adjustGroupSize(delta) {
        var newSize = state.partySize + delta;
        if (newSize < 2) return;
        if (newSize > 20) {
            alert('For groups of 20+, our corporate team can arrange custom training.\nCall 0419 675 022 or visit our corporate page.');
            return;
        }
        state.partySize = newSize;
        document.getElementById('groupSizeDisplay').textContent = newSize;
        updateGroupCompanyField();
        renderLocationCards();
        fireEvent('bf_group_size_set', { size: newSize });
    }

    function updateGroupCompanyField() {
        document.getElementById('groupCompanyField').style.display = state.partySize >= 4 ? 'block' : 'none';
    }


    // --- Select Earliest ---
    function selectEarliestSession(locationId) {
        var earliest = getEarliestSession(locationId);
        if (!earliest) return;
        var s = earliest.session;

        state.location = locationId;
        state.locationLabel = locationMeta[locationId].label;
        state.locationAddress = locationMeta[locationId].address;
        state.sessionId = s.id;
        state.sessionDate = s.dateISO;
        state.sessionLabel = s.label;
        state.sessionStart = s.start;
        state.sessionEnd = s.end;

        fireEvent('bf_location_selected', { location: locationId, method: 'earliest', session_id: s.id });
        navigateTo('step-course');
    }


    // --- Session Modal ---
    var sessionModalLocation = null;
    var sessionModalFilter = null;

    function openSessionModal(locationId) {
        sessionModalLocation = locationId;
        sessionModalFilter = null;
        document.getElementById('sessionModalTitle').textContent = esc(locationMeta[locationId].label) + ' Sessions';
        renderSessionFilter(locationId);
        renderSessionList(locationId, null);
        document.getElementById('sessionModal').classList.add('open');
        fireEvent('bf_see_all_dates', { location: locationId });
    }

    function renderSessionFilter(locationId) {
        var courseIds = Object.keys(sessionIndex);
        var html = '<button class="bf-filter-btn active" onclick="filterSessions(null, this)">All courses</button>';
        courseIds.forEach(function(cid) {
            var sessions = sessionIndex[cid] && sessionIndex[cid][locationId];
            if (sessions && sessions.length > 0) {
                html += '<button class="bf-filter-btn" onclick="filterSessions(\'' + cid + '\', this)">' +
                    esc(courseMeta[cid].code) + '</button>';
            }
        });
        document.getElementById('sessionCourseFilter').innerHTML = html;
    }

    function filterSessions(courseId, btn) {
        sessionModalFilter = courseId;
        document.querySelectorAll('.bf-filter-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        renderSessionList(sessionModalLocation, courseId);
    }

    function renderSessionList(locationId, filterCourseId) {
        var results = getSessionsForLocation(locationId, filterCourseId);
        if (results.length === 0) {
            document.getElementById('sessionModalList').innerHTML = '<p style="text-align:center;color:var(--gray-500);padding:var(--space-4);">No sessions available.</p>';
            return;
        }

        var html = '';
        results.forEach(function(r) {
            var s = r.session;
            var hasSpace = s.seatsLeft >= state.partySize;
            var seatsClass = s.seatsLeft <= 4 ? 'low' : 'ok';
            var disabledClass = hasSpace ? '' : ' disabled';

            html += '<div class="bf-session-item' + disabledClass + '"' +
                (hasSpace ? ' onclick="selectSessionFromModal(\'' + s.id + '\', \'' + r.courseId + '\')"' : '') + '>' +
                '<div>' +
                    '<div class="bf-session-date">' + esc(s.label) + '</div>' +
                    '<div class="bf-session-time">' + esc(s.start) + ' &ndash; ' + esc(s.end) + '</div>' +
                    '<div class="bf-session-badges">' +
                        '<span class="bf-session-badge">' + esc(r.courseCode) + '</span>' +
                    '</div>' +
                '</div>' +
                '<span class="bf-seats ' + seatsClass + '">' +
                    (hasSpace ? s.seatsLeft + ' seats' : 'Only ' + s.seatsLeft + ' seat' + (s.seatsLeft !== 1 ? 's' : '')) +
                '</span>' +
            '</div>';
        });

        document.getElementById('sessionModalList').innerHTML = html;
    }

    function selectSessionFromModal(sessionId, courseId) {
        // Find the session object
        var locId = sessionModalLocation;
        var sessions = sessionIndex[courseId] && sessionIndex[courseId][locId];
        if (!sessions) return;
        var sess = null;
        for (var i = 0; i < sessions.length; i++) {
            if (sessions[i].id === sessionId) { sess = sessions[i]; break; }
        }
        if (!sess) return;

        state.location = locId;
        state.locationLabel = locationMeta[locId].label;
        state.locationAddress = locationMeta[locId].address;
        state.sessionId = sess.id;
        state.sessionDate = sess.dateISO;
        state.sessionLabel = sess.label;
        state.sessionStart = sess.start;
        state.sessionEnd = sess.end;

        closeModal('sessionModal');
        fireEvent('bf_session_selected', { session_id: sessionId, location: locId, course: courseId });
        navigateTo('step-course');
    }

    function closeModal(modalId, event) {
        if (event && event.target !== event.currentTarget) return;
        document.getElementById(modalId).classList.remove('open');
    }

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.bf-modal-overlay.open').forEach(function(m) {
                m.classList.remove('open');
            });
        }
    });


    // =====================================================
    // STEP B: Course Selection
    // =====================================================

    function selectCourse(courseId, cardEl) {
        document.querySelectorAll('.bf-course-card').forEach(function(c) {
            c.classList.remove('selected');
        });
        cardEl.classList.add('selected');
        state.courseId = courseId;

        fireEvent('bf_course_selected', { course: courseId });

        // Small delay for visual feedback
        setTimeout(function() {
            checkSessionSwap();
            populateConfirmStep();
            navigateTo('step-confirm');
        }, 200);
    }


    // --- Session Swap Logic ---
    function checkSessionSwap() {
        var courseId = state.courseId;
        var locationId = state.location;
        var selectedDate = state.sessionDate;

        if (!courseId || !locationId || !selectedDate) return;

        var courseSessions = sessionIndex[courseId] && sessionIndex[courseId][locationId];

        // No sessions at all for this course at this location
        if (!courseSessions || courseSessions.length === 0) {
            state.swapped = true;
            state.originalSessionId = state.sessionId;
            state.sessionId = null;
            state.sessionDate = null;
            state.sessionLabel = null;
            state.sessionStart = null;
            state.sessionEnd = null;
            return;
        }

        // Check if same date exists
        var exactMatch = null;
        for (var i = 0; i < courseSessions.length; i++) {
            if (courseSessions[i].dateISO === selectedDate && courseSessions[i].seatsLeft >= state.partySize) {
                exactMatch = courseSessions[i];
                break;
            }
        }

        if (exactMatch) {
            // Same date available - update session ID (times may differ)
            state.sessionId = exactMatch.id;
            state.sessionLabel = exactMatch.label;
            state.sessionStart = exactMatch.start;
            state.sessionEnd = exactMatch.end;
            state.swapped = false;
            return;
        }

        // No exact match - find nearest future session with enough seats
        state.swapped = true;
        state.originalSessionId = state.sessionId;

        var nearest = null;
        var minDiff = Infinity;
        var selectedTime = new Date(selectedDate).getTime();

        for (var j = 0; j < courseSessions.length; j++) {
            var s = courseSessions[j];
            if (s.seatsLeft < state.partySize) continue;
            var diff = Math.abs(new Date(s.dateISO).getTime() - selectedTime);
            if (diff < minDiff) {
                minDiff = diff;
                nearest = s;
            }
        }

        if (nearest) {
            state.sessionId = nearest.id;
            state.sessionDate = nearest.dateISO;
            state.sessionLabel = nearest.label;
            state.sessionStart = nearest.start;
            state.sessionEnd = nearest.end;
        } else {
            state.sessionId = null;
            state.sessionDate = null;
            state.sessionLabel = null;
            state.sessionStart = null;
            state.sessionEnd = null;
        }
    }


    // =====================================================
    // STEP C: Confirm + Booking Form
    // =====================================================

    function populateConfirmStep() {
        var course = courseMeta[state.courseId];
        if (!course) return;

        document.getElementById('confirmCourseName').textContent = course.offerName;
        document.getElementById('confirmCourseCode').textContent = course.code;
        document.getElementById('confirmDuration').textContent = course.duration;

        if (state.sessionLabel && state.sessionStart) {
            document.getElementById('confirmDate').innerHTML = esc(state.sessionLabel) + ' &bull; ' + esc(state.sessionStart) + ' &ndash; ' + esc(state.sessionEnd);
        } else {
            document.getElementById('confirmDate').textContent = 'To be confirmed';
        }

        document.getElementById('confirmLocation').innerHTML = esc(state.locationLabel) + ' &mdash; ' + esc(state.locationAddress);

        // Price
        var unitPrice = course.price;
        var totalPrice = unitPrice * state.partySize;
        document.getElementById('confirmPrice').textContent = '$' + totalPrice;
        if (state.partySize > 1) {
            document.getElementById('confirmPriceNote').textContent = '$' + unitPrice + ' x ' + state.partySize + ' people \u2022 pay on the day';
        } else {
            document.getElementById('confirmPriceNote').textContent = 'per person \u2022 pay on the day';
        }

        // Swap notice
        var swapEl = document.getElementById('swapNotice');
        if (state.swapped && state.sessionId) {
            swapEl.style.display = 'block';
            swapEl.innerHTML = '<strong>Date adjusted:</strong> Your original date isn\'t available for ' + esc(course.code) + '. ' +
                'We\'ve moved you to <strong>' + esc(state.sessionLabel) + '</strong> (the nearest date). ' +
                '<button class="bf-see-all" style="display:inline;" onclick="openSessionModal(\'' + state.location + '\')">Choose a different date</button>';
            fireEvent('bf_session_swap', {
                original_session: state.originalSessionId,
                new_session: state.sessionId,
                course: state.courseId
            });
        } else if (state.swapped && !state.sessionId) {
            swapEl.style.display = 'block';
            swapEl.innerHTML = '<strong>No sessions available</strong> for ' + esc(course.code) + ' at ' + esc(state.locationLabel) + ' right now. ' +
                'Call <a href="tel:0419675022" style="color:#92400e;font-weight:600;">0419 675 022</a> to arrange a booking.';
        } else {
            swapEl.style.display = 'none';
        }

        // Group confirm row
        var groupRow = document.getElementById('groupConfirmRow');
        if (state.partySize > 1) {
            groupRow.style.display = 'flex';
            document.getElementById('groupConfirmText').textContent = 'Booking for ' + state.partySize + ' people';
            document.getElementById('groupConfirmTotal').textContent = 'Total: $' + totalPrice;
        } else {
            groupRow.style.display = 'none';
        }

        // Company field for groups
        var companyField = document.getElementById('companyFieldConfirm');
        if (state.partySize >= 4) {
            companyField.style.display = 'block';
            // Pre-fill from Step A
            var cn = document.getElementById('companyName');
            if (cn && cn.value) {
                document.getElementById('bfCompany').value = cn.value;
            }
        } else {
            companyField.style.display = 'none';
        }
    }


    // --- Form Submission ---
    var formStartFired = false;

    function trackFormStart() {
        if (!formStartFired) {
            formStartFired = true;
            fireEvent('bf_form_start', {});
        }
    }

    function submitBooking() {
        var firstName = document.getElementById('bfFirstName').value.trim();
        var lastName = document.getElementById('bfLastName').value.trim();
        var email = document.getElementById('bfEmail').value.trim();
        var phone = document.getElementById('bfPhone').value.trim();
        var employer = document.getElementById('bfEmployer').value.trim();
        var company = document.getElementById('bfCompany').value.trim();

        // Validation
        if (!firstName) { shakeField('bfFirstName'); return; }
        if (!lastName) { shakeField('bfLastName'); return; }
        if (!email || email.indexOf('@') === -1) { shakeField('bfEmail'); return; }
        if (!phone || phone.length < 8) { shakeField('bfPhone'); return; }
        if (state.partySize >= 4 && !company) { shakeField('bfCompany'); return; }

        var btn = document.getElementById('submitBtn');
        btn.textContent = 'Reserving...';
        btn.disabled = true;
        btn.style.opacity = '0.7';

        var course = courseMeta[state.courseId] || {};
        var fd = new FormData();
        fd.append('first_name', firstName);
        fd.append('last_name', lastName);
        fd.append('email', email);
        fd.append('phone', phone);
        if (employer) fd.append('employer', employer);
        if (company) fd.append('company', company);
        fd.append('course', (course.offerName || '') + ' (' + (course.code || '') + ')');
        fd.append('price', '$' + (course.price || ''));
        fd.append('location', state.locationLabel || state.location);
        fd.append('party_size', state.partySize);

        if (state.sessionId) {
            fd.append('session_id', state.sessionId);
            fd.append('session_date', state.sessionDate);
            fd.append('session_label', state.sessionLabel + ' ' + state.sessionStart + '-' + state.sessionEnd);
        } else {
            fd.append('session_id', 'request_next_available');
            fd.append('session_date', 'Next available');
        }

        if (state.swapped) {
            fd.append('session_swapped', 'yes');
            fd.append('original_session', state.originalSessionId || '');
        }

        var totalPrice = (course.price || 0) * state.partySize;
        fd.append('total_price', '$' + totalPrice);
        fd.append('_subject', 'NEW BOOKING: ' + (course.offerName || state.courseId) + ' - ' + firstName + ' ' + lastName +
            (state.sessionLabel ? ' (' + state.sessionLabel + ')' : ''));

        fireEvent('bf_submit', {
            course: state.courseId,
            session_id: state.sessionId,
            location: state.location,
            party_size: state.partySize,
            price: totalPrice
        });

        fetch('https://formspree.io/f/PLACEHOLDER_BOOKING', {
            method: 'POST',
            body: fd,
            headers: { 'Accept': 'application/json' }
        }).then(function(response) {
            if (response.ok) {
                fireEvent('bf_submit_success', {
                    course: state.courseId,
                    session_id: state.sessionId,
                    price: totalPrice,
                    party_size: state.partySize
                });
                window.location.href = 'thanks.html?type=booking';
            } else {
                handleSubmitError('response_not_ok');
            }
        }).catch(function() {
            handleSubmitError('network_error');
        });
    }

    function handleSubmitError(errorType) {
        fireEvent('bf_submit_error', { error_type: errorType });
        // Fallback: mailto
        sendBookingEmailFallback();
        window.location.href = 'thanks.html?type=booking';
    }

    function sendBookingEmailFallback() {
        var course = courseMeta[state.courseId] || {};
        var firstName = document.getElementById('bfFirstName').value.trim();
        var lastName = document.getElementById('bfLastName').value.trim();
        var email = document.getElementById('bfEmail').value.trim();
        var phone = document.getElementById('bfPhone').value.trim();

        var subject = encodeURIComponent('NEW BOOKING: ' + (course.offerName || '') + ' - ' + firstName + ' ' + lastName);
        var body = encodeURIComponent(
            'Name: ' + firstName + ' ' + lastName + '\n' +
            'Email: ' + email + '\n' +
            'Phone: ' + phone + '\n' +
            'Course: ' + (course.offerName || '') + ' (' + (course.code || '') + ')\n' +
            'Location: ' + (state.locationLabel || '') + '\n' +
            'Date: ' + (state.sessionLabel || 'Next available') + ' ' + (state.sessionStart || '') + '\n' +
            'Party size: ' + state.partySize + '\n' +
            'Total: $' + ((course.price || 0) * state.partySize)
        );
        window.open('mailto:?subject=' + subject + '&body=' + body, '_self');
    }

    function shakeField(fieldId) {
        var el = document.getElementById(fieldId);
        el.focus();
        el.style.borderColor = 'var(--red)';
        el.classList.add('shake');
        setTimeout(function() {
            el.classList.remove('shake');
            el.style.borderColor = '';
        }, 500);
    }


    // =====================================================
    // HELP ME CHOOSE FLOW
    // =====================================================

    var helpQ1Answer = null;

    function openHelpFlow() {
        helpQ1Answer = null;
        document.getElementById('helpQ1').style.display = 'block';
        document.getElementById('helpQ2').style.display = 'none';
        document.getElementById('helpResult').style.display = 'none';
        document.getElementById('helpModal').classList.add('open');
        fireEvent('bf_help_open', {});
    }

    function helpAnswer(question, answer) {
        if (question === 1) {
            helpQ1Answer = answer;
            fireEvent('bf_help_q1_answer', { answer: answer });
            if (answer === 'childcare') {
                // Immediate recommendation
                showHelpResult('hltaid012', 'Childcare / Education (ACECQA approved)',
                    'Since you work in childcare or education, you need ACECQA-approved training.');
            } else {
                // Show Q2
                document.getElementById('helpQ1').style.display = 'none';
                document.getElementById('helpQ2').style.display = 'block';
            }
        } else if (question === 2) {
            fireEvent('bf_help_q2_answer', { answer: answer });
            if (answer === 'cpr') {
                showHelpResult('hltaid009', 'CPR Renewal',
                    'If your employer specifically requires CPR only, this is the right choice.');
            } else {
                showHelpResult('hltaid011', 'Keep me compliant (Full First Aid)',
                    'Most workplaces accept Full First Aid. It\'s the safest choice if you\'re unsure.');
            }
        }
    }

    function showHelpResult(courseId, title, reason) {
        state.helpUsed = true;
        state.helpRecommendation = courseId;

        document.getElementById('helpQ1').style.display = 'none';
        document.getElementById('helpQ2').style.display = 'none';
        document.getElementById('helpResult').style.display = 'block';

        document.getElementById('helpRecTitle').textContent = 'We recommend: ' + title;
        document.getElementById('helpRecReason').textContent = reason;
        document.getElementById('helpRecBtn').setAttribute('data-course', courseId);

        fireEvent('bf_help_result', { recommended_course: courseId });
    }

    function applyHelpRecommendation() {
        var courseId = document.getElementById('helpRecBtn').getAttribute('data-course');
        closeModal('helpModal');

        // Select the card visually
        var card = document.querySelector('.bf-course-card[data-course="' + courseId + '"]');
        if (card) {
            document.querySelectorAll('.bf-course-card').forEach(function(c) { c.classList.remove('selected'); });
            card.classList.add('selected');
        }

        state.courseId = courseId;
        fireEvent('bf_course_selected', { course: courseId, source: 'help_flow' });

        setTimeout(function() {
            checkSessionSwap();
            populateConfirmStep();
            navigateTo('step-confirm');
        }, 200);
    }


    // =====================================================
    // INITIALIZATION
    // =====================================================

    (function init() {
        // Track form start on first field interaction
        var formFields = ['bfFirstName', 'bfLastName', 'bfEmail', 'bfPhone', 'bfEmployer', 'bfCompany'];
        formFields.forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.addEventListener('focus', trackFormStart, { once: true });
        });

        // Load data and render
        loadSessionData().then(function() {
            renderLocationCards();

            // Check for deep-link params
            var params = new URLSearchParams(window.location.search);
            var locParam = params.get('location');
            var courseParam = params.get('course');

            if (locParam && locationMeta[locParam]) {
                state.location = locParam;
                state.locationLabel = locationMeta[locParam].label;
                state.locationAddress = locationMeta[locParam].address;

                // Find earliest session for this location
                var earliest = getEarliestSession(locParam);
                if (earliest) {
                    state.sessionId = earliest.session.id;
                    state.sessionDate = earliest.session.dateISO;
                    state.sessionLabel = earliest.session.label;
                    state.sessionStart = earliest.session.start;
                    state.sessionEnd = earliest.session.end;
                }

                if (courseParam && courseMeta[courseParam]) {
                    state.courseId = courseParam;
                    checkSessionSwap();
                    populateConfirmStep();
                    navigateTo('step-course');
                    navigateTo('step-confirm');
                } else {
                    navigateTo('step-course');
                }
            }

            fireEvent('bf_funnel_start', { path: window.location.pathname });
        });
    })();

    </script>
</body>
</html>
